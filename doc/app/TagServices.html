<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class TagServices - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Object.html">Object</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-child_ids">::child_ids</a>
    
    <li ><a href="#method-c-define">::define</a>
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-c-parent_ids">::parent_ids</a>
    
    <li ><a href="#method-c-qa">::qa</a>
    
    <li ><a href="#method-c-semantic_neighborhood">::semantic_neighborhood</a>
    
    <li ><a href="#method-c-synonym_ids">::synonym_ids</a>
    
    <li ><a href="#method-c-time_lookup">::time_lookup</a>
    
    <li ><a href="#method-c-yumm">::yumm</a>
    
    <li ><a href="#method-i-child_ids">#child_ids</a>
    
    <li ><a href="#method-i-child_referents">#child_referents</a>
    
    <li ><a href="#method-i-children">#children</a>
    
    <li ><a href="#method-i-has_image">#has_image</a>
    
    <li ><a href="#method-i-images">#images</a>
    
    <li ><a href="#method-i-lexical_similars">#lexical_similars</a>
    
    <li ><a href="#method-i-make_parent_of">#make_parent_of</a>
    
    <li ><a href="#method-i-page_refs_of_kind">#page_refs_of_kind</a>
    
    <li ><a href="#method-i-parent_ids">#parent_ids</a>
    
    <li ><a href="#method-i-parents">#parents</a>
    
    <li ><a href="#method-i-recipe_ids">#recipe_ids</a>
    
    <li ><a href="#method-i-recipes">#recipes</a>
    
    <li ><a href="#method-i-referents">#referents</a>
    
    <li ><a href="#method-i-retypeable-3F">#retypeable?</a>
    
    <li ><a href="#method-i-similar_ids">#similar_ids</a>
    
    <li ><a href="#method-i-sites">#sites</a>
    
    <li ><a href="#method-i-suggests">#suggests</a>
    
    <li ><a href="#method-i-suggests-3F">#suggests?</a>
    
    <li ><a href="#method-i-synonym_ids">#synonym_ids</a>
    
    <li ><a href="#method-i-synonyms">#synonyms</a>
    
    <li ><a href="#method-i-taggee_ids">#taggee_ids</a>
    
    <li ><a href="#method-i-taggees">#taggees</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-TagServices">
  <h1 id="class-TagServices" class="class">
    class TagServices
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-tag" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">tag</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-child_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">child_ids</span><span
            class="method-args">(ids)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="child_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 87</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">child_ids</span>(<span class="ruby-identifier">ids</span>)
  <span class="ruby-constant">ExpressionServices</span>.<span class="ruby-identifier">child_ids_of_tags</span>(<span class="ruby-identifier">ids</span>) <span class="ruby-operator">-</span> [<span class="ruby-identifier">ids</span>].<span class="ruby-identifier">flatten</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-define" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">define</span><span
            class="method-args">(tag_or_tagname, options={})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Given a name (or the tag thereof), ensure the existence of: – a tag of the
tagtype – a referent “defining” that kind of entity – a page_ref to the
page for such a definition – optionally, an <a
href="ImageReference.html">ImageReference</a> for that entity</p>
          
          

          
          <div class="method-source-code" id="define-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 186</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">define</span> <span class="ruby-identifier">tag_or_tagname</span>, <span class="ruby-identifier">options</span>={}
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tag_or_tagname</span>
  <span class="ruby-identifier">page_link</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:page_link</span>]
  <span class="ruby-identifier">image_link</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:image_link</span>]
  <span class="ruby-identifier">location</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tag</span> =
      <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">tag</span> =
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:tagtype</span>]
              <span class="ruby-comment"># Force the existence of a tag of the given type</span>
              <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">assert</span>(<span class="ruby-identifier">tag_or_tagname</span>, <span class="ruby-identifier">tt</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag_or_tagname</span>.<span class="ruby-identifier">present?</span>
            <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">tag_or_tagname</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Tag</span>)
              <span class="ruby-identifier">tag_or_tagname</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>
          <span class="ruby-identifier">tag_ref</span> = <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">tag</span>
          <span class="ruby-identifier">location</span> =
              <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_link</span>
                <span class="ruby-comment"># Asserting the page_ref ensures a referent for the tag # Referent.express(tag) if tag.referents.empty?</span>
                <span class="ruby-identifier">page_ref</span> = <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">fetch</span> <span class="ruby-identifier">page_link</span>
                <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">kind</span> = (<span class="ruby-identifier">options</span>[<span class="ruby-value">:page_kind</span>] <span class="ruby-operator">||</span> <span class="ruby-value">:about</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">persisted?</span>
                <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">assert_referent</span> <span class="ruby-identifier">tag_ref</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">empty?</span>
                <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">link_text</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:link_text</span>].<span class="ruby-identifier">strip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:link_text</span>].<span class="ruby-identifier">present?</span> <span class="ruby-comment"># Force the link text to something else</span>
                <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">save!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">changed?</span>
                <span class="ruby-identifier">page_link</span>
              <span class="ruby-keyword">else</span>
                <span class="ruby-string">&#39;(no page_ref)&#39;</span>
              <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">tag</span>
      <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tag_or_tagname</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Tag</span>)
    <span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;!!!Scraper Defined #{tag.typename} link to #{tag.name} (Tag ##{tag.id}) at #{location}&quot;</span>
    <span class="ruby-identifier">msg</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; with image #{image_link}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">image_link</span>.<span class="ruby-identifier">present?</span>
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">msg</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent_tag</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:kind_of</span>]
    <span class="ruby-identifier">parent_tag</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">define</span> <span class="ruby-identifier">parent_tag</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-value">:tagtype</span>)
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!!!Scraper  ...made &#39;#{tag.name}&#39; a kind of &#39;#{parent_tag.name}&#39;&quot;</span>
    <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">parent_tag</span>).<span class="ruby-identifier">make_parent_of</span> <span class="ruby-identifier">tag</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">source_tag</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:suggested_by</span>]
    <span class="ruby-identifier">source_tag</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">define</span> <span class="ruby-identifier">source_tag</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-value">:tagtype</span>)
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!!!Scraper  ...noted that &#39;#{tag.name}&#39; is suggested by &#39;#{source_tag.name}&#39;&quot;</span>
    <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">source_tag</span>).<span class="ruby-identifier">suggests</span> <span class="ruby-identifier">tag</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">target_tag</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:suggests</span>]
    <span class="ruby-identifier">target_tag</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">define</span> <span class="ruby-identifier">target_tag</span>, <span class="ruby-identifier">options</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-value">:tagtype</span>)
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!!!Scraper  ...noted that &#39;#{tag.name}&#39; suggests &#39;#{target_tag.name}&#39;&quot;</span>
    <span class="ruby-identifier">suggests</span> <span class="ruby-identifier">target_tag</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:description</span>].<span class="ruby-identifier">present?</span>
    <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">description</span>.<span class="ruby-identifier">present?</span>
        <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">description</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:description</span>]
        <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">has_image</span> <span class="ruby-constant">ReferenceServices</span>.<span class="ruby-identifier">assert_image_for_referent</span>(<span class="ruby-identifier">image_link</span>, <span class="ruby-identifier">tag</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">image_link</span>
  <span class="ruby-identifier">tag</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(tag, user=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 10</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">tag</span>, <span class="ruby-identifier">user</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tag</span> = <span class="ruby-identifier">tag</span>
  <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">user</span> <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">super_id</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-parent_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parent_ids</span><span
            class="method-args">(ids, unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="parent_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 99</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent_ids</span> <span class="ruby-identifier">ids</span>, <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-constant">ExpressionServices</span>.<span class="ruby-identifier">parent_ids_of_tags</span> <span class="ruby-identifier">ids</span>, <span class="ruby-identifier">unique</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-qa" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">qa</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Class method meant to be run from a console, to clean up redundant tags
(name/index pair not unique) before adding index to prevent them</p>
          
          

          
          <div class="method-source-code" id="qa-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 294</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">qa</span>
  <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagqa</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">errors</span>[<span class="ruby-value">:key</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">other</span> = <span class="ruby-identifier">clashing_tag</span>
        <span class="ruby-identifier">other</span>.<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">tag</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-semantic_neighborhood" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">semantic_neighborhood</span><span
            class="method-args">(tag_ids, min_weight = 0.4)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>

<p>Analyze the tag or set of tags for semantic neighbors, returning a list of 
tag/weight pairs. …a tag in the original set and its synonyms get a weight
of 1 …semantic children of the originals get weight 1/2 …semantic parents
of the originals get weight 1/3</p>
          
          

          
          <div class="method-source-code" id="semantic_neighborhood-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 280</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">semantic_neighborhood</span>(<span class="ruby-identifier">tag_ids</span>, <span class="ruby-identifier">min_weight</span> = <span class="ruby-value">0.4</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">new_tag_ids</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">synonym_ids</span> <span class="ruby-identifier">tag_ids</span>
  <span class="ruby-identifier">weight</span> = <span class="ruby-value">1.0</span>
  <span class="ruby-keyword">until</span> <span class="ruby-identifier">new_tag_ids</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">weight</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">min_weight</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">new_tag_ids</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tagid</span><span class="ruby-operator">|</span> <span class="ruby-identifier">result</span>[<span class="ruby-identifier">tagid</span>] = <span class="ruby-identifier">weight</span> }
    <span class="ruby-identifier">new_tag_ids</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">child_ids</span>(<span class="ruby-identifier">new_tag_ids</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">keys</span>
    <span class="ruby-identifier">weight</span> = <span class="ruby-identifier">weight</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-synonym_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">synonym_ids</span><span
            class="method-args">(ids_in, unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="synonym_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 74</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">synonym_ids</span>(<span class="ruby-identifier">ids_in</span>, <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">ids</span> = <span class="ruby-constant">ExpressionServices</span>.<span class="ruby-identifier">synonym_ids_of_tags</span>(<span class="ruby-identifier">ids_in</span>, <span class="ruby-identifier">unique</span>)
  <span class="ruby-identifier">unique</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ids</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">ids_in</span>].<span class="ruby-identifier">flatten</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">ids</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-time_lookup" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">time_lookup</span><span
            class="method-args">(ix=1)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="time_lookup-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 304</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">time_lookup</span> <span class="ruby-identifier">ix</span>=<span class="ruby-value">1</span>
  <span class="ruby-identifier">label</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">index_name</span> = <span class="ruby-identifier">index_table</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">tag_ids</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>)
  <span class="ruby-identifier">time</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">measure</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">ix</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">label</span> = <span class="ruby-string">&quot;Tag via ID&quot;</span>
        <span class="ruby-identifier">index_table</span> = <span class="ruby-value">:tags</span>
        <span class="ruby-identifier">index_name</span> = <span class="ruby-string">&quot;tags_index_by_id&quot;</span>
        <span class="ruby-identifier">tag_ids</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">name</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">name</span>
        }
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">index_status</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">index_name_exists?</span>( <span class="ruby-identifier">index_table</span>, <span class="ruby-identifier">index_name</span>, <span class="ruby-keyword">false</span>) <span class="ruby-operator">?</span> <span class="ruby-string">&quot;indexed&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;unindexed&quot;</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;db_timings&quot;</span>, <span class="ruby-string">&#39;a&#39;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">label</span><span class="ruby-operator">+</span><span class="ruby-node">&quot; (#{Time.new} #{index_status}): &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&quot;\n&quot;</span>)
  }
  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-yumm" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">yumm</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Study the Yummly dataset for correspondence with RecipePower&#39;s</p>
          
          

          
          <div class="method-source-code" id="yumm-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 329</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yumm</span>
  <span class="ruby-identifier">file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span> <span class="ruby-string">&quot;yumm.json&quot;</span>
  <span class="ruby-comment"># ingreds = JSON.parse file</span>
  <span class="ruby-identifier">results</span> = <span class="ruby-identifier">ingreds</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ingred</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">strmatch</span> <span class="ruby-identifier">ingred</span>[<span class="ruby-string">&quot;term&quot;</span>], <span class="ruby-identifier">matchall</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
    (<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">?</span> <span class="ruby-node">&quot;No match on #{ingred[&quot;term&quot;]}&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-node">&quot;Matched #{ingred[&quot;term&quot;]}:&quot;</span>)<span class="ruby-operator">+</span>
        <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;\n\t#{tag.typename} #{tag.id}: #{tag.name}&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;&#39;</span>)
  }.<span class="ruby-identifier">sort</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line1</span>, <span class="ruby-identifier">line2</span><span class="ruby-operator">|</span> <span class="ruby-identifier">line1</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">line2</span> }
  <span class="ruby-identifier">results</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span> <span class="ruby-identifier">puts</span> <span class="ruby-identifier">line</span> }
  <span class="ruby-identifier">total</span> = <span class="ruby-identifier">results</span>.<span class="ruby-identifier">count</span>
  <span class="ruby-identifier">nmatched</span> = <span class="ruby-identifier">results</span>.<span class="ruby-identifier">keep_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">result</span><span class="ruby-operator">|</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">match</span> <span class="ruby-regexp">/^Matched/</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">count</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Matched #{nmatched} of #{total}.&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-child_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">child_ids</span><span
            class="method-args">(unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>
          
          

          
          <div class="method-source-code" id="child_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 83</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">child_ids</span> <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-constant">ExpressionServices</span>.<span class="ruby-identifier">child_ids_of_tags</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">unique</span>) <span class="ruby-operator">-</span> [<span class="ruby-identifier">id</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-child_referents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">child_referents</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="child_referents-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 161</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">child_referents</span>
  <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">referent</span><span class="ruby-operator">|</span> <span class="ruby-identifier">referent</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">to_a</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-children" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">children</span><span
            class="method-args">(unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="children-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 91</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">children</span> <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">where</span> <span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">child_ids</span>(<span class="ruby-identifier">unique</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-has_image" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_image</span><span
            class="method-args">(image_ref)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="has_image-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 170</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_image</span> <span class="ruby-identifier">image_ref</span>
  <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">referent</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">referent</span>.<span class="ruby-identifier">image_refs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">image_ref</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">referent</span>.<span class="ruby-identifier">image_refs</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">image_ref</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-images" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">images</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>

<p>Look up all the images attached to all the referents of the tag</p>
          
          

          
          <div class="method-source-code" id="images-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 166</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">images</span>
  <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">referent</span><span class="ruby-operator">|</span> <span class="ruby-identifier">referent</span>.<span class="ruby-identifier">image_refs</span>.<span class="ruby-identifier">to_a</span> }.<span class="ruby-identifier">flatten</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lexical_similars" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lexical_similars</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p># ———————————————– # Return tags that match any of the given tags
lexically, regardless of type # TODO: this should only address taggable
tags</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexical_similars</span>(<span class="ruby-identifier">tags</span>)
  <span class="ruby-identifier">results</span> = <span class="ruby-identifier">tags</span>
  <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span> 
    <span class="ruby-identifier">matches</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">strmatch</span>(<span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span>)
    <span class="ruby-identifier">results</span> = <span class="ruby-identifier">results</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">matches</span><span class="ruby-operator">-</span><span class="ruby-identifier">results</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">matches</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">results</span>
<span class="ruby-keyword">end</span>
</pre>

<p># Return tags that match the tag lexically, regardless of type</p>
          
          

          
          <div class="method-source-code" id="lexical_similars-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 264</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">lexical_similars</span>
  <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">taggables</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">normalized_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">normalized_name</span>).<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">id</span>).<span class="ruby-identifier">to_a</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-make_parent_of" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">make_parent_of</span><span
            class="method-args">(child_tag, move=true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Ensure that the child tag has a referent that is a child of our referent</p>
          
          

          
          <div class="method-source-code" id="make_parent_of-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">make_parent_of</span> <span class="ruby-identifier">child_tag</span>, <span class="ruby-identifier">move</span>=<span class="ruby-keyword">true</span>
  <span class="ruby-comment"># NB: If the child needs to change type, and if there is a name clash with an existing type,</span>
  <span class="ruby-comment"># Tag.assert WILL RETURN A TAG DIFFERENT THAN THAT PROVIDED. Thus,</span>
  <span class="ruby-comment"># THE RETURN VALUE OF THIS METHOD NEEDS TO BE ATTENDED TO</span>
  <span class="ruby-comment"># In the event of failure, any errors are attached to the tag returned, which may be the original tag</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">child_tag</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tag</span>
    <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value">:id</span>, <span class="ruby-string">&#39;refers to the same tag&#39;</span>
    <span class="ruby-identifier">tag</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">child_tag</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">assert</span> <span class="ruby-identifier">child_tag</span>, <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">child_tag</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tag</span> <span class="ruby-comment"># We MAY have mapped an untyped tag onto our new &quot;parent&quot; =&gt; act as absorb</span>
          <span class="ruby-identifier">tag</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">child_ref</span> = <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">child_tag</span>
          (<span class="ruby-identifier">child_tag</span>.<span class="ruby-identifier">referent_ids</span> <span class="ruby-operator">&amp;</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referent_ids</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">exid</span><span class="ruby-operator">|</span>
            <span class="ruby-comment"># child_tag and tag are synonyms on some referent(s), so child needs to be removed from those refs</span>
            <span class="ruby-identifier">child_tag</span>.<span class="ruby-identifier">elide_meaning</span> <span class="ruby-identifier">child_tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">exid</span>)
            <span class="ruby-identifier">child_ref</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">child_ref</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">exid</span> <span class="ruby-comment"># Can&#39;t use a referent of the parent as the child&#39;s referent</span>
          }
          <span class="ruby-comment"># Force the creation of a new meaning for the child if it was a synonym of the parent</span>
          <span class="ruby-identifier">child_ref</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">child_tag</span>, <span class="ruby-identifier">force</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">parent_ref</span> = <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">tag</span>
          <span class="ruby-identifier">parent_ref</span>.<span class="ruby-identifier">make_parent_of</span> <span class="ruby-identifier">child_ref</span>, <span class="ruby-identifier">move</span>
          <span class="ruby-comment"># Raise an error to back out of the whole thing</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-identifier">parent_ref</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent_ref</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>
          <span class="ruby-identifier">child_tag</span>.<span class="ruby-identifier">save</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-identifier">child_tag</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">full_messages</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">child_tag</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>
          <span class="ruby-identifier">parent_ref</span>.<span class="ruby-identifier">save</span>
          <span class="ruby-identifier">child_ref</span>.<span class="ruby-identifier">save</span>
          <span class="ruby-identifier">child_tag</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value">:child</span>, <span class="ruby-node">&quot;#{child_tag.name} can&#39;t be added to #{tag.name}: #{e}&quot;</span>
      <span class="ruby-identifier">tag</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-page_refs_of_kind" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">page_refs_of_kind</span><span
            class="method-args">(kind)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Get all the PageRefs associated with the tag, which consists of two
populations 1) PageRefs that are tagged explicitly by the tag and–possibly,
depending on with_synonyms–its synonyms 2) PageRefs that are linked to the
tag&#39;s referent(s)</p>
          
          

          
          <div class="method-source-code" id="page_refs_of_kind-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 56</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">page_refs_of_kind</span> <span class="ruby-identifier">kind</span>
  <span class="ruby-comment"># entity_class = entity_class_name.constantize</span>
  <span class="ruby-comment"># id_or_ids = with_synonyms ? synonym_ids : id</span>
  <span class="ruby-identifier">synids</span> = <span class="ruby-identifier">synonym_ids</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">synids</span>.<span class="ruby-identifier">present?</span>
    <span class="ruby-identifier">assoc</span> = <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">of_kind</span>(<span class="ruby-identifier">kind</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taggings</span>).<span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;taggings.tag_id in (#{(synids &lt;&lt; id).join(&#39;,&#39;)})&quot;</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">assoc</span> = <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">of_kind</span>(<span class="ruby-identifier">kind</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taggings</span>).<span class="ruby-identifier">where</span>(<span class="ruby-node">&quot;taggings.tag_id = #{id}&quot;</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">referred_page_refs</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>(<span class="ruby-keyword">true</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">referent</span><span class="ruby-operator">|</span> <span class="ruby-identifier">referent</span>.<span class="ruby-identifier">page_refs</span>.<span class="ruby-identifier">of_kind</span> <span class="ruby-identifier">kind</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
  (<span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">to_a</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">referred_page_refs</span>).<span class="ruby-identifier">compact</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-parent_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parent_ids</span><span
            class="method-args">(unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>
          
          

          
          <div class="method-source-code" id="parent_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 95</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parent_ids</span> <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-constant">ExpressionServices</span>.<span class="ruby-identifier">parent_ids_of_tags</span> <span class="ruby-identifier">id</span>, <span class="ruby-identifier">unique</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-parents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parents</span><span
            class="method-args">(unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="parents-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 103</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parents</span> <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-constant">ExpressionServices</span>.<span class="ruby-identifier">parent_tags_of_tags</span> <span class="ruby-identifier">id</span>, <span class="ruby-identifier">unique</span>
  <span class="ruby-comment"># Tag.where id: parent_ids</span>
  <span class="ruby-comment"># pi.collect { |parent_set| Tag.where id: parent_set }</span>
  <span class="ruby-comment"># Tag.where id: parent_ids</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-recipe_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">recipe_ids</span><span
            class="method-args">(with_synonyms=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>
          
          

          
          <div class="method-source-code" id="recipe_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 24</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">recipe_ids</span> <span class="ruby-identifier">with_synonyms</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-identifier">with_synonyms</span> <span class="ruby-operator">?</span>
      <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> ([<span class="ruby-identifier">id</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">synonym_ids</span>) ).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">recipe_ids</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span> <span class="ruby-operator">:</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">recipe_ids</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-recipes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">recipes</span><span
            class="method-args">(with_synonyms=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="recipes-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 30</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">recipes</span> <span class="ruby-identifier">with_synonyms</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-constant">Recipe</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">recipe_ids</span>(<span class="ruby-identifier">with_synonyms</span>) )
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-referents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">referents</span><span
            class="method-args">(exclude_self=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="referents-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 15</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">referents</span> <span class="ruby-identifier">exclude_self</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-identifier">exclude_self</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referent_id</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-retypeable-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">retypeable?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Can the associated tag have its type changed?</p>
          
          

          
          <div class="method-source-code" id="retypeable-3F-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 177</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">retypeable?</span>
  <span class="ruby-operator">!</span>(<span class="ruby-identifier">parent_ids</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">child_ids</span>.<span class="ruby-identifier">present?</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-similar_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">similar_ids</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="similar_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 268</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">similar_ids</span>
  <span class="ruby-identifier">relation_or_array</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">strmatch</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span>
  <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">relation_or_array</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">relation_or_array</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:id</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">relation_or_array</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:id</span>)
  <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">keep_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">candidate</span><span class="ruby-operator">|</span> <span class="ruby-identifier">candidate</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">id</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sites" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sites</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>
          
          

          
          <div class="method-source-code" id="sites-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 20</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sites</span>
  <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">typesym</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Source</span> <span class="ruby-operator">?</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">referent_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referent_ids</span>) <span class="ruby-operator">:</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">site_ids</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-suggests" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">suggests</span><span
            class="method-args">(target_tag)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>
          
          

          
          <div class="method-source-code" id="suggests-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 153</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">suggests</span> <span class="ruby-identifier">target_tag</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">express</span>(<span class="ruby-identifier">tag</span>).<span class="ruby-identifier">suggests</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">express</span>(<span class="ruby-identifier">target_tag</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-suggests-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">suggests?</span><span
            class="method-args">(target_tag)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="suggests-3F-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 157</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">suggests?</span> <span class="ruby-identifier">target_tag</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">express</span>(<span class="ruby-identifier">tag</span>).<span class="ruby-identifier">suggests?</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">express</span>(<span class="ruby-identifier">target_tag</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-synonym_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">synonym_ids</span><span
            class="method-args">(unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>
          
          

          
          <div class="method-source-code" id="synonym_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 69</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">synonym_ids</span> <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-identifier">ids</span> = <span class="ruby-constant">ExpressionServices</span>.<span class="ruby-identifier">synonym_ids_of_tags</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">unique</span>)
  <span class="ruby-identifier">unique</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ids</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">id</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">ids</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-synonyms" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">synonyms</span><span
            class="method-args">(unique=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="synonyms-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 79</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">synonyms</span> <span class="ruby-identifier">unique</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">where</span> <span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">synonym_ids</span>(<span class="ruby-identifier">unique</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-taggee_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">taggee_ids</span><span
            class="method-args">(with_synonyms=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <hr>
          
          

          
          <div class="method-source-code" id="taggee_ids-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 35</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">taggee_ids</span> <span class="ruby-identifier">with_synonyms</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-identifier">id_or_ids</span> = <span class="ruby-identifier">with_synonyms</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">synonym_ids</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">id</span>
  <span class="ruby-identifier">taggings</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">tag_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">id_or_ids</span>).<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:entity_type</span>, <span class="ruby-value">:entity_id</span>).<span class="ruby-identifier">inject</span>({}) { <span class="ruby-operator">|</span><span class="ruby-identifier">memo</span>, <span class="ruby-identifier">pair</span><span class="ruby-operator">|</span>
    (<span class="ruby-identifier">memo</span>[<span class="ruby-identifier">pair</span>.<span class="ruby-identifier">first</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pair</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-identifier">memo</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-taggees" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">taggees</span><span
            class="method-args">(with_synonyms=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="taggees-source">
            <pre><span class="ruby-comment"># File app/services/tag_services.rb, line 43</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">taggees</span> <span class="ruby-identifier">with_synonyms</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-identifier">taggee_ids</span>(<span class="ruby-identifier">with_synonyms</span>).<span class="ruby-identifier">inject</span>({}) { <span class="ruby-operator">|</span><span class="ruby-identifier">memo</span>, <span class="ruby-identifier">keyval</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">keyval</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">constantize</span>
    <span class="ruby-identifier">memo</span>[<span class="ruby-identifier">klass</span>] = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">keyval</span>.<span class="ruby-identifier">last</span>)
    <span class="ruby-identifier">memo</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

