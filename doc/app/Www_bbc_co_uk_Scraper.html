<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class Www_bbc_co_uk_Scraper - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Scraper.html">Scraper</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-handler">::handler</a>
    
    <li ><a href="#method-i-accordions">#accordions</a>
    
    <li ><a href="#method-i-bbc_chef_home_page">#bbc_chef_home_page</a>
    
    <li ><a href="#method-i-bbc_chef_recipes_page">#bbc_chef_recipes_page</a>
    
    <li ><a href="#method-i-bbc_chefs_atoz_page">#bbc_chefs_atoz_page</a>
    
    <li ><a href="#method-i-bbc_chefs_page">#bbc_chefs_page</a>
    
    <li ><a href="#method-i-bbc_collection_home_page">#bbc_collection_home_page</a>
    
    <li ><a href="#method-i-bbc_course_recipes_page">#bbc_course_recipes_page</a>
    
    <li ><a href="#method-i-bbc_cuisine_home_page">#bbc_cuisine_home_page</a>
    
    <li ><a href="#method-i-bbc_cuisine_recipes_page">#bbc_cuisine_recipes_page</a>
    
    <li ><a href="#method-i-bbc_cuisines_page">#bbc_cuisines_page</a>
    
    <li ><a href="#method-i-bbc_define_collection">#bbc_define_collection</a>
    
    <li ><a href="#method-i-bbc_diet_home_page">#bbc_diet_home_page</a>
    
    <li ><a href="#method-i-bbc_diet_recipes_page">#bbc_diet_recipes_page</a>
    
    <li ><a href="#method-i-bbc_dish_recipes_page">#bbc_dish_recipes_page</a>
    
    <li ><a href="#method-i-bbc_dishes_atoz_page">#bbc_dishes_atoz_page</a>
    
    <li ><a href="#method-i-bbc_dishes_page">#bbc_dishes_page</a>
    
    <li ><a href="#method-i-bbc_food_home_page">#bbc_food_home_page</a>
    
    <li ><a href="#method-i-bbc_food_page">#bbc_food_page</a>
    
    <li ><a href="#method-i-bbc_ingredients_by_letter">#bbc_ingredients_by_letter</a>
    
    <li ><a href="#method-i-bbc_ingredients_page">#bbc_ingredients_page</a>
    
    <li ><a href="#method-i-bbc_keyword_recipes_page">#bbc_keyword_recipes_page</a>
    
    <li ><a href="#method-i-bbc_occasion_home_page">#bbc_occasion_home_page</a>
    
    <li ><a href="#method-i-bbc_occasion_recipes_page">#bbc_occasion_recipes_page</a>
    
    <li ><a href="#method-i-bbc_occasions_page">#bbc_occasions_page</a>
    
    <li ><a href="#method-i-bbc_programme_home_page">#bbc_programme_home_page</a>
    
    <li ><a href="#method-i-bbc_programme_recipes_page">#bbc_programme_recipes_page</a>
    
    <li ><a href="#method-i-bbc_programmes_page">#bbc_programmes_page</a>
    
    <li ><a href="#method-i-bbc_recipe_home_page">#bbc_recipe_home_page</a>
    
    <li ><a href="#method-i-bbc_recipes_page">#bbc_recipes_page</a>
    
    <li ><a href="#method-i-bbc_season_home_page">#bbc_season_home_page</a>
    
    <li ><a href="#method-i-bbc_seasons_page">#bbc_seasons_page</a>
    
    <li ><a href="#method-i-bbc_tag_recipes_page">#bbc_tag_recipes_page</a>
    
    <li ><a href="#method-i-bbc_technique_home_page">#bbc_technique_home_page</a>
    
    <li ><a href="#method-i-bbc_technique_recipes_page">#bbc_technique_recipes_page</a>
    
    <li ><a href="#method-i-bbc_techniques_page">#bbc_techniques_page</a>
    
    <li ><a href="#method-i-define_linked_tag">#define_linked_tag</a>
    
    <li ><a href="#method-i-headered_list_items">#headered_list_items</a>
    
    <li ><a href="#method-i-recipe_item">#recipe_item</a>
    
    <li ><a href="#method-i-tag_def_label">#tag_def_label</a>
    
    <li ><a href="#method-i-tag_item">#tag_item</a>
    
    <li ><a href="#method-i-tidy_name">#tidy_name</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Www_bbc_co_uk_Scraper">
  <h1 id="class-Www_bbc_co_uk_Scraper" class="class">
    class Www_bbc_co_uk_Scraper
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-handler" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">handler</span><span
            class="method-args">(url_or_uri)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Predict what handler will scrape the page</p>
          
          

          
          <div class="method-source-code" id="handler-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 299</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">handler</span> <span class="ruby-identifier">url_or_uri</span>
  <span class="ruby-identifier">uri</span> = <span class="ruby-identifier">url_or_uri</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">?</span> (<span class="ruby-identifier">normalized_uri</span> <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">url_or_uri</span>)) <span class="ruby-operator">:</span> <span class="ruby-identifier">url_or_uri</span>
  <span class="ruby-keyword">case</span> <span class="ruby-constant">URI</span>.<span class="ruby-identifier">decode</span> [<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/\/$/</span>,<span class="ruby-string">&#39;&#39;</span>), <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">query</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;?&#39;</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A\/food\z/</span>
      <span class="ruby-value">:bbc_food_page</span>
    <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A\/food\/(chefs|dishes)\/by\/letter(s)?\//</span>
      <span class="ruby-value">:&quot;bbc_#{$1}_atoz_page&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A\/food\/(dishes|chefs|recipes|seasons|techniques|occasions|cuisines|ingredients|programmes)\z/</span>
      <span class="ruby-node">&quot;bbc_#{$1}_page&quot;</span>.<span class="ruby-identifier">to_sym</span>
     <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A\/food\/(courses|occasions|techniques|seasons|cuisines|programmes|collections|diets|chefs|recipes)\/[-\w]+\z/</span>
      <span class="ruby-node">&quot;bbc_#{$1.singularize}_home_page&quot;</span>.<span class="ruby-identifier">to_sym</span>
    <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A\/food\/recipes\/search\?.*(dishes|occasions|chefs|programmes|courses|diets|cuisines|keywords)((\[[^\]]*\])?=|\/)([^&amp;]*)/</span>
      <span class="ruby-node">&quot;bbc_#{$1.singularize}_recipes_page&quot;</span>.<span class="ruby-identifier">to_sym</span>
    <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A\/food\/ingredients\/by\/letter\/[a-z]\z/</span>
      <span class="ruby-value">:bbc_ingredients_by_letter</span>
    <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A\/food\/[-\w]+\z/</span>
      <span class="ruby-value">:bbc_food_home_page</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">x</span>=<span class="ruby-value">2</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-accordions" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">accordions</span><span
            class="method-args">(enclosure_selector=nil, extractions={}) { |header_name, li, extractions| ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="accordions-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 409</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">accordions</span> <span class="ruby-identifier">enclosure_selector</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">extractions</span>={}
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">enclosure_selector</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Hash</span>
    <span class="ruby-identifier">enclosure_selector</span>, <span class="ruby-identifier">extractions</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">enclosure_selector</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-node">%w{ .accordion .resource_list #dishes-filters }</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">div_class</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">headered_list_items</span> <span class="ruby-node">&quot;#{enclosure_selector} h3.accordion-header&quot;</span>, <span class="ruby-string">&#39;div&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">div_class</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">header_name</span> = <span class="ruby-identifier">title</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/^[A-Z]/</span>, <span class="ruby-operator">&amp;</span><span class="ruby-value">:downcase</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
        <span class="ruby-keyword">yield</span> <span class="ruby-identifier">header_name</span>, <span class="ruby-identifier">li</span>, <span class="ruby-identifier">extractions</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-comment"># Assume a recipe, and the header is a role</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">header_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;other&#39;</span>
          <span class="ruby-identifier">course_name</span> = <span class="ruby-keyword">nil</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">course_name</span> = <span class="ruby-identifier">header_name</span>.<span class="ruby-identifier">downcase</span>
          <span class="ruby-comment"># TagServices.define course_name, :tagtype =&gt; :Course</span>
          <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">course_name</span>, <span class="ruby-value">:Course</span>
          <span class="ruby-identifier">course_name</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">recipe_item</span> <span class="ruby-identifier">li</span>, <span class="ruby-identifier">extractions</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-string">&#39;Course&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">course_name</span>).<span class="ruby-identifier">compact</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_chef_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_chef_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_chef_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 489</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_chef_home_page</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span> = <span class="ruby-identifier">url</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/chefs(\[[^\]]*\]=|\/)([^&amp;]*)/</span>)
    <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span> <span class="ruby-value">:url</span>, <span class="ruby-string">&#39;doesn\t match the format of a chefs page&#39;</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;h1.fn&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">author_name</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">content</span>
    <span class="ruby-comment"># author_tag = TagServices.define( author_name,</span>
    <span class="ruby-comment">#                          tagtype: &#39;Author&#39;,</span>
    <span class="ruby-comment">#                          page_link: url)</span>
    <span class="ruby-identifier">author_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">author_name</span>, <span class="ruby-value">:Author</span>, <span class="ruby-identifier">url</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">item</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#overview p&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">description</span> = <span class="ruby-identifier">item</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">author_tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">description</span>.<span class="ruby-identifier">present?</span>
          <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">description</span> = <span class="ruby-identifier">description</span>.<span class="ruby-identifier">truncate</span> <span class="ruby-value">250</span>
          <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">save</span>
        <span class="ruby-keyword">end</span>
      }
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># Scrape recipes filed under Dishes accordions</span>
    <span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;Author&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">author_name</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div.links-module h2&#39;</span>, <span class="ruby-string">&#39;ul&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hdr_title</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">hdr_title</span>.<span class="ruby-identifier">match</span>( <span class="ruby-string">&#39;Elsewhere&#39;</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>)
      <span class="ruby-comment"># TagServices.define author_tag, page_link: absolutize(link), link_text: link.content</span>
      <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">author_tag</span>, <span class="ruby-identifier">link</span>, <span class="ruby-identifier">link_text</span><span class="ruby-operator">:</span> <span class="ruby-identifier">link</span>.<span class="ruby-identifier">content</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_chef_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_chef_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_chef_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 606</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_chef_recipes_page</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Author</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_chefs_atoz_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_chefs_atoz_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_chefs_atoz_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 465</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_chefs_atoz_page</span>
  <span class="ruby-identifier">chef_ids</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">links_with</span>(<span class="ruby-identifier">href</span><span class="ruby-operator">:</span> <span class="ruby-regexp">/\A\/food\/chefs\/[-\w]+\z/</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">link</span>.<span class="ruby-identifier">href</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;/&#39;</span>).<span class="ruby-identifier">last</span>
  }.<span class="ruby-identifier">compact</span>
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">chef_ids</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">chef_id</span><span class="ruby-operator">|</span>
           <span class="ruby-string">&#39;http://www.bbc.co.uk/food/chefs/&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">chef_id</span>
         }
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">chef_ids</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">chef_id</span><span class="ruby-operator">|</span>
           <span class="ruby-string">&#39;http://www.bbc.co.uk/food/recipes/search?chefs[]=&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">chef_id</span>
         }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_chefs_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_chefs_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Recipes, by chef #####################</p>
          
          

          
          <div class="method-source-code" id="bbc_chefs_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 457</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_chefs_page</span> <span class="ruby-comment"># Top level of chef scraping</span>
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">page</span>.<span class="ruby-identifier">links_with</span>(<span class="ruby-identifier">href</span><span class="ruby-operator">:</span> <span class="ruby-regexp">/\/by\/letters\//</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_collection_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_collection_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_collection_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 847</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_collection_home_page</span>
  <span class="ruby-identifier">description_item</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#quote-module p&#39;</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_list</span> (<span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h1&#39;</span>).<span class="ruby-identifier">text</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; (BBC Food)&#39;</span>),
                          <span class="ruby-value">:description</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">description_item</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">description_item</span>.<span class="ruby-identifier">text</span>)
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#the-collection a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">member_link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">extractions</span> = {}
    <span class="ruby-identifier">rlink</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">member_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">rpic</span> = <span class="ruby-identifier">member_link</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Image&#39;</span>] = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">rpic</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Title&#39;</span>] = <span class="ruby-identifier">member_link</span>.<span class="ruby-identifier">content</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">add_to_list</span> <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_recipe</span>(<span class="ruby-identifier">rlink</span>, <span class="ruby-identifier">extractions</span>), <span class="ruby-identifier">list</span>
  }
  <span class="ruby-comment"># accordions &#39;List&#39; =&gt; list_name</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_course_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_course_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_course_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 594</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_course_recipes_page</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Course</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_cuisine_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_cuisine_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>def bbc_dish_home_page</p>

<pre class="ruby"><span class="ruby-identifier">dish_name</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h1&#39;</span>).<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/([-\w]*) recipes/</span>, <span class="ruby-string">&#39;\1&#39;</span>
<span class="ruby-identifier">dish_tag</span> = <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">define</span>(<span class="ruby-identifier">dish_name</span>,
                              :<span class="ruby-identifier">tagtype</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-constant">Dish</span>,
                              :<span class="ruby-identifier">page_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">url</span>)
<span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;Dish&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dish_name</span>
<span class="ruby-identifier">ts</span> = <span class="ruby-keyword">nil</span>
<span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div#related-foods h3&#39;</span>, <span class="ruby-string">&#39;ul&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">title</span>.<span class="ruby-identifier">match</span> <span class="ruby-regexp">/^Varieties of/</span>
    <span class="ruby-identifier">ts</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">dish_tag</span>)
    <span class="ruby-identifier">ts</span>.<span class="ruby-identifier">make_parent_of</span> <span class="ruby-identifier">tag_item</span>(<span class="ruby-identifier">li</span>, :<span class="ruby-constant">Dish</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># A see-also section within a &#39;links-module&#39; div</span>
<span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div.links-module a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">see_also_link</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">define</span> <span class="ruby-identifier">dish_tag</span>, <span class="ruby-identifier">page_link</span><span class="ruby-operator">:</span> <span class="ruby-identifier">absolutize</span>(<span class="ruby-identifier">see_also_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>))
}

<span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a.see-all-search&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">launch</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>), :<span class="ruby-identifier">bbc_dish_recipes_page</span> }
</pre>

<p>end</p>

<p>def bbc_ingredient_home_page</p>

<pre class="ruby"><span class="ruby-comment"># e.g., http://www.bbc.co.uk/food/candied_peel</span>
<span class="ruby-identifier">tagname</span> =
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">link</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">links_with</span>(<span class="ruby-identifier">href</span><span class="ruby-operator">:</span> <span class="ruby-regexp">/\/food\/recipes\/search\b.*\bkeywords=/</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">link</span>.<span class="ruby-identifier">href</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\/food\/recipes\/search\b.*\bkeywords=([-\w\s]*)/</span>, <span class="ruby-string">&#39;\1&#39;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">downcase!</span>
<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!!!Scraper Defined Tag &#39;#{tagname}&#39; for #{url}&quot;</span>
<span class="ruby-identifier">ingredient_tag</span> = <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">define</span>(<span class="ruby-identifier">tagname</span>,
                                    :<span class="ruby-identifier">tagtype</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-constant">Ingredient</span>,
                                    :<span class="ruby-identifier">page_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">url</span>,
                                    :<span class="ruby-identifier">image_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">absolutize</span>(<span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;img#food-image&#39;</span>, :<span class="ruby-identifier">src</span>)))

<span class="ruby-comment"># scrape the related-foods section</span>
<span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#related-foods h3&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">related_section</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">list</span> = <span class="ruby-identifier">related_section</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;~ ul&#39;</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">resources</span> = <span class="ruby-identifier">list</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;li a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">related_link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">definition_link</span> = <span class="ruby-identifier">related_link</span>.<span class="ruby-identifier">attribute</span> <span class="ruby-string">&#39;href&#39;</span>
    <span class="ruby-identifier">definition_name</span> = <span class="ruby-identifier">related_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">related_link</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">img_link</span>, :<span class="ruby-identifier">src</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">related_section</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^Varieties/</span>
        <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">define</span>(<span class="ruby-identifier">definition_name</span>.<span class="ruby-identifier">downcase</span>,
                           :<span class="ruby-identifier">tagtype</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-constant">Ingredient</span>,
                           :<span class="ruby-identifier">page_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">absolutize</span>(<span class="ruby-identifier">definition_link</span>),
                           :<span class="ruby-identifier">image_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">img_link</span>,
                           :<span class="ruby-identifier">kind_of</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ingredient_tag</span>)
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^Typically made with/</span>
        <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">define</span>(<span class="ruby-identifier">definition_name</span>.<span class="ruby-identifier">downcase</span>,
                           :<span class="ruby-identifier">tagtype</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-constant">Dish</span>,
                           :<span class="ruby-identifier">page_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">absolutize</span>(<span class="ruby-identifier">definition_link</span>),
                           :<span class="ruby-identifier">image_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">img_link</span>,
                           :<span class="ruby-identifier">suggested_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ingredient_tag</span>)
    <span class="ruby-keyword">end</span>
  }
}

<span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;Ingredients&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tagname</span>
</pre>

<p>end</p>
          
          

          
          <div class="method-source-code" id="bbc_cuisine_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 1075</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_cuisine_home_page</span>
  <span class="ruby-identifier">genre_name</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h1&#39;</span>).<span class="ruby-identifier">text</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/.*\s([-\w]*\z)/</span>, <span class="ruby-string">&#39;\1&#39;</span>
  <span class="ruby-comment"># genre_tag = TagServices.define(genre_name,</span>
  <span class="ruby-comment">#                                :tagtype =&gt; :Genre,</span>
  <span class="ruby-comment">#                                :page_link =&gt; url)</span>
  <span class="ruby-identifier">genre_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">genre_name</span>, <span class="ruby-value">:Genre</span>, <span class="ruby-identifier">url</span>
  <span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;Genre&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">genre_name</span>
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div.related-resources-module h2&#39;</span>, <span class="ruby-string">&#39;ul&#39;</span>, <span class="ruby-string">&#39;Related chefs&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># The &#39;Related Chefs&#39; section</span>
    <span class="ruby-identifier">tag</span> = <span class="ruby-identifier">tag_item</span> <span class="ruby-identifier">li</span>
    <span class="ruby-identifier">genre_tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">genre_ref</span><span class="ruby-operator">|</span> <span class="ruby-identifier">genre_ref</span>.<span class="ruby-identifier">author_referents</span> <span class="ruby-operator">|=</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div.related-resources-module h3&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">tag</span> = <span class="ruby-identifier">tag_item</span> <span class="ruby-identifier">li</span>, <span class="ruby-identifier">title</span>.<span class="ruby-identifier">singularize</span>.<span class="ruby-identifier">to_sym</span>
    <span class="ruby-identifier">genre_tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">genre_ref</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">typesym</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:Author</span>
          <span class="ruby-identifier">genre_ref</span>.<span class="ruby-identifier">author_referents</span> <span class="ruby-operator">|=</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:Ingredient</span>
          <span class="ruby-identifier">genre_ref</span>.<span class="ruby-identifier">ingredient_referents</span> <span class="ruby-operator">|=</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:Dish</span>
          <span class="ruby-identifier">genre_ref</span>.<span class="ruby-identifier">dish_referents</span> <span class="ruby-operator">|=</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># A see-also section within a &#39;links-module&#39; div</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div.links-module a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">see_also_link</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># TagServices.define genre_tag, page_link: absolutize(see_also_link.attribute(&#39;href&#39;))</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">genre_tag</span>, <span class="ruby-identifier">see_also_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_cuisine_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_cuisine_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_cuisine_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 610</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_cuisine_recipes_page</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Genre</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_cuisines_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_cuisines_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_cuisines_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 779</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_cuisines_page</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;ol#cuisines li.cuisine a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">season_link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">tag_name</span> = <span class="ruby-identifier">season_link</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;span.cuisine-title&#39;</span>).<span class="ruby-identifier">text</span>
    <span class="ruby-identifier">page_link</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">season_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">season_link</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>)
      <span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">img_link</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!!!Scraper Defined Tag &#39;#{tag_name}&#39; -&gt; #{page_link} and image link #{img_link}&quot;</span>
    <span class="ruby-comment"># TagServices.define tag_name,</span>
    <span class="ruby-comment">#                    tagtype: &#39;Genre&#39;,</span>
    <span class="ruby-comment">#                    page_link: page_link,</span>
    <span class="ruby-comment">#                    image_link: img_link</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tag_name</span>, <span class="ruby-value">:Genre</span>, <span class="ruby-identifier">page_link</span>, <span class="ruby-identifier">image_link</span><span class="ruby-operator">:</span> <span class="ruby-identifier">img_link</span>
    <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">page_link</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_define_collection" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_define_collection</span><span
            class="method-args">(cname, home_link, image_link=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_define_collection-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 864</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_define_collection</span> <span class="ruby-identifier">cname</span>, <span class="ruby-identifier">home_link</span>, <span class="ruby-identifier">image_link</span>=<span class="ruby-keyword">nil</span>
  <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_list</span> (<span class="ruby-identifier">cname</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; (BBC Food)&#39;</span>),
                          <span class="ruby-identifier">picurl</span><span class="ruby-operator">:</span> (<span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">image_link</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">image_link</span>)
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">home_link</span>, <span class="ruby-value">:bbc_collection_home_page</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_diet_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_diet_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_diet_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 826</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_diet_home_page</span>
  <span class="ruby-identifier">diet_name</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h1&#39;</span>).<span class="ruby-identifier">text</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\s.*/</span>, <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-comment"># diet_tag = TagServices.define diet_name,</span>
  <span class="ruby-comment">#     :tagtype =&gt; :Diet,</span>
  <span class="ruby-comment">#     :page_link =&gt; url</span>
  <span class="ruby-identifier">diet_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">diet_name</span>, <span class="ruby-value">:Diet</span>, <span class="ruby-identifier">url</span>
  <span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;Diet&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">diet_name</span>
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div.links-module h2&#39;</span>, <span class="ruby-string">&#39;ul&#39;</span> <span class="ruby-keyword">do</span>  <span class="ruby-operator">|</span><span class="ruby-identifier">header_text</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">header_text</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Elsewhere on the web&#39;</span>
      <span class="ruby-identifier">see_also_link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-comment"># TagServices.define diet_tag,</span>
      <span class="ruby-comment">#                    page_link: absolutize(see_also_link.attribute(&#39;href&#39;)),</span>
      <span class="ruby-comment">#                    link_text: see_also_link.text.strip</span>
      <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">diet_tag</span>,
                             <span class="ruby-identifier">see_also_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>),
                             <span class="ruby-identifier">link_text</span><span class="ruby-operator">:</span> <span class="ruby-identifier">see_also_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a.see-all-search&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>) }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_diet_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_diet_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_diet_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 598</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_diet_recipes_page</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Diet</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_dish_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_dish_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_dish_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 602</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_dish_recipes_page</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Dish</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_dishes_atoz_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_dishes_atoz_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_dishes_atoz_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 477</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_dishes_atoz_page</span>
  <span class="ruby-identifier">dish_ids</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;li.resource.food a&#39;</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">a</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\/food\/(\w*)\b.*$/</span>, <span class="ruby-string">&#39;\1&#39;</span>
  }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">dish_ids</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">dish_id</span><span class="ruby-operator">|</span>
           <span class="ruby-string">&#39;http://www.bbc.co.uk/food/&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dish_id</span>
         }
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">dish_ids</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">dish_id</span><span class="ruby-operator">|</span>
           <span class="ruby-string">&#39;http://www.bbc.co.uk/food/recipes/search?dishes[]=&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dish_id</span>
         }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_dishes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_dishes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_dishes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 461</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_dishes_page</span> <span class="ruby-comment"># Top level of dish scraping</span>
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">page</span>.<span class="ruby-identifier">links_with</span>(<span class="ruby-identifier">href</span><span class="ruby-operator">:</span> <span class="ruby-regexp">/\/by\/letter\//</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_food_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_food_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Handler that covers dish and ingredient home pages, both of which are like
&#39;/food/&lt;name&gt;&#39;</p>
          
          

          
          <div class="method-source-code" id="bbc_food_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 919</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_food_home_page</span>
  <span class="ruby-comment"># The first thing is to distinguish between the two cases by consulting the sub-heading at the top of the page</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">subhead</span> = <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;p#sub-heading&#39;</span>).<span class="ruby-identifier">strip</span>
    <span class="ruby-identifier">typename</span> = <span class="ruby-identifier">subhead</span>.<span class="ruby-identifier">singularize</span>
    <span class="ruby-identifier">tagtype</span> = <span class="ruby-identifier">typename</span>.<span class="ruby-identifier">to_sym</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># INGREDIENT home page</span>
  <span class="ruby-comment"># DISH home page</span>
  <span class="ruby-comment"># Recipes for &lt;dish&gt;: dish</span>
  <span class="ruby-comment"># Recipes using &lt;ingredient&gt;: dish, ingredient</span>
  <span class="ruby-comment"># &lt;Ingredient&gt; Parts of &lt;ingredient&gt;: dish</span>
  <span class="ruby-comment"># &lt;Ingredient&gt; Varieties of &lt;ingredient&gt;: dish</span>
  <span class="ruby-comment"># &lt;Dish&gt; Typically made with &lt;dish&gt;: dish</span>
  <span class="ruby-comment"># &lt;Ingredients&gt; Other &lt;parent ingred.&gt; (multiple): ingredient</span>

  <span class="ruby-identifier">tagname</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h1&#39;</span>).<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/([-\w]*) recipes/</span>, <span class="ruby-string">&#39;\1&#39;</span>).<span class="ruby-identifier">downcase</span>
  <span class="ruby-identifier">image_link</span> = (<span class="ruby-identifier">absolutize</span>(<span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;img#food-image&#39;</span>, <span class="ruby-value">:src</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">tagtype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Ingredient</span>) <span class="ruby-comment"># No pic for Dishes</span>
  <span class="ruby-comment"># tag = TagServices.define(tagname, {</span>
  <span class="ruby-comment">#                                     :tagtype =&gt; tagtype,</span>
  <span class="ruby-comment">#                                     :page_link =&gt; url,</span>
  <span class="ruby-comment">#                                     :image_link =&gt; image_link</span>
  <span class="ruby-comment">#                                 }.compact</span>
  <span class="ruby-comment"># )</span>
  <span class="ruby-identifier">tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tagname</span>, <span class="ruby-identifier">tagtype</span>, <span class="ruby-identifier">url</span>, <span class="ruby-value">:image_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">image_link</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a.see-all-search&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>) }
  <span class="ruby-comment"># The two &#39;grouped-resource-list-module&#39; accordions have different extractions.</span>
  <span class="ruby-comment"># The one labeled &#39;Recipes for&#39; uses the tag in the context of a dish</span>
  <span class="ruby-comment"># The one labeled &#39;Recipes using&#39; uses the tag in the context of an ingredient</span>
  <span class="ruby-comment"># page.search(&#39;a.see-all-search&#39;).each { |a| launch a.attribute(&#39;href&#39;), :bbc_dish_recipes_page }</span>
  <span class="ruby-identifier">n</span> = <span class="ruby-value">1</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div.grouped-resource-list-module&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">group</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">h2</span> = <span class="ruby-identifier">group</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;h2&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">h2</span>.<span class="ruby-identifier">text</span>
        <span class="ruby-keyword">when</span> <span class="ruby-regexp">/Recipes for/</span>
          <span class="ruby-comment"># TagServices.define(tagname, {</span>
          <span class="ruby-comment">#                               :tagtype =&gt; :Dish,</span>
          <span class="ruby-comment">#                               :page_link =&gt; url,</span>
          <span class="ruby-comment">#                               :image_link =&gt; image_link</span>
          <span class="ruby-comment">#                           }.compact</span>
          <span class="ruby-comment"># ) unless tag.typesym == :Dish</span>
          <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span>( <span class="ruby-identifier">tagname</span>, <span class="ruby-value">:Dish</span>, <span class="ruby-identifier">url</span>, <span class="ruby-value">:image_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">image_link</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">typesym</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Dish</span>
          <span class="ruby-identifier">accordions</span> <span class="ruby-node">&quot;div.grouped-resource-list-module:nth-of-type(#{n})&quot;</span>, <span class="ruby-string">&#39;Dish&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tagname</span>
        <span class="ruby-keyword">when</span> <span class="ruby-regexp">/Recipes using/</span>
          <span class="ruby-comment"># TagServices.define(tagname, {</span>
          <span class="ruby-comment">#                               :tagtype =&gt; :Ingredient,</span>
          <span class="ruby-comment">#                               :page_link =&gt; url,</span>
          <span class="ruby-comment">#                               :image_link =&gt; image_link</span>
          <span class="ruby-comment">#                           }.compact</span>
          <span class="ruby-comment"># ) unless tag.typesym == :Ingredient</span>
          <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span>( <span class="ruby-identifier">tagname</span>, <span class="ruby-value">:Ingredient</span>, <span class="ruby-identifier">url</span>, <span class="ruby-value">:image_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">image_link</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">typesym</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Ingredient</span>
          <span class="ruby-identifier">accordions</span> <span class="ruby-node">&quot;div.grouped-resource-list-module:nth-of-type(#{n})&quot;</span>, <span class="ruby-string">&#39;Ingredient&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tagname</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">n</span> = <span class="ruby-identifier">n</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
  }

  <span class="ruby-comment"># We determine what category(ies) the entity is in by reference to the &#39;Other...&#39; links sections in the right column</span>
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div#related-foods h3&#39;</span>, <span class="ruby-string">&#39;ul&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">title</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^Other(.*)$/</span>
        <span class="ruby-comment"># parent_tag = TagServices.define($1, tagtype: tag.tagtype)</span>
        <span class="ruby-identifier">parent_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-node">$1</span>, <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span>, <span class="ruby-identifier">child_of</span><span class="ruby-operator">:</span> <span class="ruby-identifier">parent_tag</span>
        <span class="ruby-comment"># TagServices.new(parent_tag).make_parent_of tag</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^Also made with(.*)$/</span>
        <span class="ruby-comment"># An ingredient that suggests this dish</span>
        <span class="ruby-comment"># ingred_tag = TagServices.define($1.strip, tagtype: :Ingredient)</span>
        <span class="ruby-identifier">ingred_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-node">$1</span>.<span class="ruby-identifier">strip</span>, <span class="ruby-value">:Ingredient</span>, <span class="ruby-identifier">suggests</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>
        <span class="ruby-comment"># TagServices.new(ingred_tag).suggests tag</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^Typically made with(.*)$/</span>
        <span class="ruby-comment"># An ingredient that suggests this dish</span>
        <span class="ruby-comment"># dish_tag = TagServices.define li.content.strip.downcase,</span>
        <span class="ruby-comment">#                               tagtype: :Dish,</span>
        <span class="ruby-comment">#                               page_link: absolutize(li.search(&#39;a&#39;).first)</span>
        <span class="ruby-identifier">dish_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">li</span>.<span class="ruby-identifier">content</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">downcase</span>,
                                          <span class="ruby-value">:Dish</span>,
                                          <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>,
                                          <span class="ruby-identifier">suggested_by</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>
        <span class="ruby-comment"># TagServices.new(tag).suggests dish_tag</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># A see-also section within a &#39;links-module&#39; div</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div.links-module a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">see_also_link</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># TagServices.define tag, page_link: absolutize(see_also_link.attribute(&#39;href&#39;))</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tag</span>, <span class="ruby-identifier">see_also_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>)
  }

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_food_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_food_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The BBC Food home page lists special diets</p>
          
          

          
          <div class="method-source-code" id="bbc_food_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 436</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_food_page</span>
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;dt#special-diets&#39;</span>, <span class="ruby-string">&#39;dd&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">header_text</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">diet_atag</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">diet_name</span> = <span class="ruby-identifier">diet_atag</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/\s*recipes$/</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">sub</span> <span class="ruby-string">&#39; &#39;</span>, <span class="ruby-string">&#39;-&#39;</span>
      <span class="ruby-comment"># diet_url = absolutize diet_atag.attribute(&#39;href&#39;)</span>
      <span class="ruby-comment"># TagServices.define diet_name.downcase,</span>
      <span class="ruby-comment">#                    :tagtype =&gt; :Diet,</span>
      <span class="ruby-comment">#                    :page_link =&gt; diet_url</span>
      <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">diet_name</span>.<span class="ruby-identifier">downcase</span>, <span class="ruby-value">:Diet</span>, <span class="ruby-identifier">diet_atag</span>
      <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">diet_atag</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;ol#site-nav a&#39;</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">match</span> <span class="ruby-regexp">/.*\/food\/(\w*)\b/</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">topic</span> = <span class="ruby-node">$1</span>).<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">link</span> <span class="ruby-keyword">unless</span> <span class="ruby-node">%w{ my about ingredients }</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">topic</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_ingredients_by_letter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_ingredients_by_letter</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_ingredients_by_letter-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 721</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_ingredients_by_letter</span>
  <span class="ruby-comment"># e.g., http://www.bbc.co.uk/food/ingredients/by/letter/o</span>
  <span class="ruby-identifier">ingredient_links</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;li.resource.food a&#39;</span>)
  <span class="ruby-identifier">ingredient_links</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">path</span> = <span class="ruby-identifier">link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">path</span>.<span class="ruby-identifier">match</span>(<span class="ruby-node">/\A\/food\/([-\w]+)#related-foods\z/</span>)
      <span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">link</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">tagname</span> = <span class="ruby-identifier">img_link</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">img_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;alt&#39;</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">downcase</span>
      <span class="ruby-comment"># TagServices.define tagname,</span>
      <span class="ruby-comment">#                    :tagtype =&gt; :Ingredient,</span>
      <span class="ruby-comment">#                    :page_link =&gt; absolutize(link),</span>
      <span class="ruby-comment">#                    :image_link =&gt; (absolutize(img_link.attribute(&#39;src&#39;)) if img_link)</span>
      <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tagname</span>,
                             <span class="ruby-value">:Ingredient</span>,
                             <span class="ruby-identifier">link</span>,
                             <span class="ruby-value">:image_link</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">img_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">img_link</span>)
      <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">link</span>
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_ingredients_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_ingredients_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Ingredients ############</p>
          
          

          
          <div class="method-source-code" id="bbc_ingredients_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 715</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_ingredients_page</span>
  <span class="ruby-identifier">scrape</span> (<span class="ruby-string">&#39;a&#39;</span><span class="ruby-operator">..</span><span class="ruby-string">&#39;z&#39;</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">letter</span><span class="ruby-operator">|</span>
           <span class="ruby-string">&#39;http://www.bbc.co.uk/food/ingredients/by/letter/&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">letter</span>
         }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_keyword_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_keyword_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_keyword_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 614</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_keyword_recipes_page</span> <span class="ruby-comment"># Because an ingredient search is denoted like keywords[]=</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Ingredient</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_occasion_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_occasion_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_occasion_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 1199</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_occasion_home_page</span>
  <span class="ruby-identifier">occ_name</span> = <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;h1&#39;</span>).<span class="ruby-identifier">strip</span>
  <span class="ruby-identifier">occ_name</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/\b\s*recipes.*$/</span>, <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-comment"># occ_tag = TagServices.define occ_name, tagtype: Tag.typenum(:Occasion), page_link: url</span>
  <span class="ruby-identifier">occ_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">occ_name</span>, <span class="ruby-value">:Occasion</span>, <span class="ruby-identifier">url</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">seemore</span> = <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;p.see-more a.see-all-search&#39;</span>, <span class="ruby-value">:href</span>)
    <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">seemore</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;Occasion&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">occ_name</span>
  <span class="ruby-identifier">occ_svcs</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#related-collections li a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">alink</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">imglink</span> = <span class="ruby-identifier">alink</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>)
    <span class="ruby-identifier">bbc_define_collection</span> <span class="ruby-identifier">alink</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>, <span class="ruby-identifier">alink</span>[<span class="ruby-string">&#39;href&#39;</span>], ((<span class="ruby-identifier">imglink</span>.<span class="ruby-identifier">attribute</span> <span class="ruby-string">&#39;src&#39;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">imglink</span>)
  }
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div.related-resources-module h3&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">resource_type</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">related_tag</span> = <span class="ruby-identifier">define_linked_tag</span>(<span class="ruby-identifier">resource_type</span>, <span class="ruby-identifier">li</span>)
      <span class="ruby-identifier">occ_svcs</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">occ_tag</span>)
      <span class="ruby-identifier">occ_svcs</span>.<span class="ruby-identifier">suggests</span> <span class="ruby-identifier">related_tag</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_occasion_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_occasion_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_occasion_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 582</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_occasion_recipes_page</span>
   <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Occasion</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_occasions_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_occasions_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_occasions_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 1182</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_occasions_page</span>
    (<span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;ul.occasions li&#39;</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;ul#other-occasions li&#39;</span>)).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">li_elmt</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">occ_link</span> = <span class="ruby-identifier">li_elmt</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;h4 a&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">occ_name</span> = <span class="ruby-identifier">occ_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">occ_link</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">occ_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>)
    <span class="ruby-keyword">end</span>
    (<span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">li_elmt</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;h4 a img&#39;</span>).<span class="ruby-identifier">first</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">img_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>))
    <span class="ruby-comment"># TagServices.define occ_name.to_s, {</span>
    <span class="ruby-comment">#                                     tagtype: :Occasion,</span>
    <span class="ruby-comment">#                                     page_link: occ_link,</span>
    <span class="ruby-comment">#                                     image_link: absolutize(img_link)</span>
    <span class="ruby-comment">#                                 }.compact</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">occ_name</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">:Occasion</span>, <span class="ruby-identifier">occ_link</span>, <span class="ruby-identifier">image_link</span><span class="ruby-operator">:</span> <span class="ruby-identifier">img_link</span>
    <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">occ_link</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_programme_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_programme_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_programme_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 1109</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_programme_home_page</span>
  <span class="ruby-comment"># The programme_link is the home page of the program on the BBC</span>
  <span class="ruby-identifier">programme_name</span> =
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">programme_link</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#episode-detail a&#39;</span>).<span class="ruby-identifier">first</span>
        <span class="ruby-identifier">programme_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-comment"># page.search(&#39;title&#39;).text.sub(/BBC - Food - Recipes from Programmes :/, &#39;&#39;).strip</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">banner</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#programme-episode h1&#39;</span>).<span class="ruby-identifier">first</span>
        <span class="ruby-identifier">banner</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&#39;recipes&#39;</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">programme_description</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#episode-detail p&#39;</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">programme_image</span> = <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;div#programme-brand img&#39;</span>, <span class="ruby-value">:src</span>)
  <span class="ruby-comment"># programme_tag = TagServices.define(programme_name,</span>
  <span class="ruby-comment">#                                    {</span>
  <span class="ruby-comment">#                                        :tagtype =&gt; :Source,</span>
  <span class="ruby-comment">#                                        :description =&gt; (programme_description.text.strip if programme_description),</span>
  <span class="ruby-comment">#                                        :page_link =&gt; url,</span>
  <span class="ruby-comment">#                                        :image_link =&gt; (programme_image if programme_image.present?)</span>
  <span class="ruby-comment">#                                    }.compact</span>
  <span class="ruby-comment"># )</span>
  <span class="ruby-identifier">programme_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">programme_name</span>,
                                         <span class="ruby-value">:Source</span>,
                                         <span class="ruby-identifier">url</span>,
                                         <span class="ruby-value">:description</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">programme_description</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">programme_description</span>),
                                         <span class="ruby-value">:image_link</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">programme_image</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">programme_image</span>.<span class="ruby-identifier">present?</span>)
  <span class="ruby-comment"># Define the reference to the program page</span>
  <span class="ruby-comment"># TagServices.define programme_tag, page_link:</span>
  <span class="ruby-comment">#                                     (absolutize(programme_link.attribute(&#39;href&#39;)) if programme_link) ||</span>
  <span class="ruby-comment">#                                         url.sub(&#39;/food/programmes/&#39;, &#39;/programmes/&#39;)</span>
  <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">programme_tag</span>, (<span class="ruby-identifier">programme_link</span> <span class="ruby-operator">?</span>
                                      <span class="ruby-identifier">programme_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>) <span class="ruby-operator">:</span>
                                      <span class="ruby-identifier">url</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&#39;/food/programmes/&#39;</span>, <span class="ruby-string">&#39;/programmes/&#39;</span>))
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div.related-resources-module h2&#39;</span>, <span class="ruby-string">&#39;ul&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">header_name</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">header_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Related chefs&#39;</span>
      <span class="ruby-identifier">link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">img</span> = <span class="ruby-identifier">link</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">chef_name</span> = <span class="ruby-identifier">img</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;alt&#39;</span>).<span class="ruby-identifier">to_s</span>
      <span class="ruby-identifier">chef_img</span> = <span class="ruby-identifier">img</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>).<span class="ruby-identifier">to_s</span>
      <span class="ruby-identifier">chef_link</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>
      <span class="ruby-comment"># chef_tag = TagServices.define chef_name, {</span>
      <span class="ruby-comment">#                                            tagtype: :Author,</span>
      <span class="ruby-comment">#                                            page_link: chef_link,</span>
      <span class="ruby-comment">#                                            image_link: chef_img</span>
      <span class="ruby-comment">#                                        }.compact</span>
      <span class="ruby-identifier">chef_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">chef_name</span>, <span class="ruby-value">:Author</span>, <span class="ruby-identifier">chef_link</span>, <span class="ruby-identifier">image_link</span><span class="ruby-operator">:</span> <span class="ruby-identifier">chef_img</span>
      <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">programme_tag</span>).<span class="ruby-identifier">suggests</span> <span class="ruby-identifier">chef_tag</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># The seemore link finds all recipes under that programme</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">seemore</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;p.see-all a.see-all-search&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">seemore</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>)
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_programme_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_programme_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_programme_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 590</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_programme_recipes_page</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Source</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_programmes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_programmes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_programmes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 742</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_programmes_page</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;li#all-programmes li a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">pid</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/.*food\/programmes\/(\w*)\b.*$/</span>, <span class="ruby-string">&#39;\1&#39;</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">pname</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">content</span>).<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pname</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/^Series/</span>)
      <span class="ruby-identifier">page_link</span> = <span class="ruby-identifier">absolutize</span>(<span class="ruby-identifier">a</span>)
      <span class="ruby-comment"># TagServices.define pname, tagtype: Tag.typenum(:Source)</span>
      <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">pname</span>, <span class="ruby-value">:Source</span>
      <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">page_link</span>
      <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">absolutize</span>(<span class="ruby-string">&#39;/food/recipes/search?programmes[]=&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">pid</span>)
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_recipe_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_recipe_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_recipe_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 673</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_recipe_home_page</span>
  <span class="ruby-comment"># e.g., http://www.bbc.co.uk/food/recipes/lemon_and_ricotta_tart_44080</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">uri</span>
    <span class="ruby-comment"># Glean title, description and image</span>
    <span class="ruby-identifier">extractions</span> = <span class="ruby-constant">HashWithIndifferentAccess</span>.<span class="ruby-identifier">new</span>(
        <span class="ruby-value">:Title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&quot;meta[property=&#39;og:title&#39;]&quot;</span>, <span class="ruby-value">:content</span>),
        <span class="ruby-value">:Description</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&quot;meta[property=&#39;og:description&#39;]&quot;</span>, <span class="ruby-value">:content</span>),
        <span class="ruby-string">&#39;Prep Time&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&quot;p.recipe-metadata__prep-time&quot;</span>),
        <span class="ruby-string">&#39;Cooking Time&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&quot;p.recipe-metadata__cook-time&quot;</span>),
        <span class="ruby-string">&#39;Yield&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;p.recipe-metadata__serving&#39;</span>),
        <span class="ruby-value">:Image</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&quot;meta[property=&#39;og:image&#39;]&quot;</span>, <span class="ruby-value">:content</span>)
    )
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">diet</span> = <span class="ruby-identifier">find_by_selector</span>(<span class="ruby-string">&#39;div.recipe-metadata__dietary a p&#39;</span>)).<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Diet&#39;</span>] = <span class="ruby-identifier">diet</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">link</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">link_with</span>(<span class="ruby-identifier">dom_class</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;chef__link&#39;</span>)
      <span class="ruby-identifier">chef_id</span> =
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> = <span class="ruby-identifier">link</span>.<span class="ruby-identifier">href</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/chefs(\[[^\]]*\]=|\/)([^&amp;]*)/</span>)
            <span class="ruby-identifier">m</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_s</span>
          <span class="ruby-keyword">end</span>
      <span class="ruby-comment"># extractions[&#39;Author&#39;] = TagServices.define(link.to_s,</span>
      <span class="ruby-comment">#                                                 tagtype: &#39;Author&#39;,</span>
      <span class="ruby-comment">#                                                 page_link: absolutize(link.href)).name</span>
      <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Author&#39;</span>] = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span>(<span class="ruby-identifier">link</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">:Author</span>, <span class="ruby-identifier">link</span>.<span class="ruby-identifier">href</span>).<span class="ruby-identifier">name</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Glean ingredient links from the page, meanwhile ensuring the tag is defined</span>
    <span class="ruby-identifier">extractions</span>[<span class="ruby-value">:Ingredients</span>] = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">links_with</span>(<span class="ruby-identifier">dom_class</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;recipe-ingredients__link&#39;</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span>
      <span class="ruby-comment"># TagServices.define(link.to_s,</span>
      <span class="ruby-comment">#                    tagtype: &#39;Ingredient&#39;,</span>
      <span class="ruby-comment">#                    page_link: absolutize(link.href)).name</span>
      <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span>(<span class="ruby-identifier">link</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">:Ingredient</span>, <span class="ruby-identifier">link</span>.<span class="ruby-identifier">href</span>).<span class="ruby-identifier">name</span>
    }.<span class="ruby-identifier">join</span> <span class="ruby-string">&#39;, &#39;</span>

    <span class="ruby-identifier">r</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_recipe</span> <span class="ruby-identifier">url</span>, <span class="ruby-identifier">extractions</span>.<span class="ruby-identifier">compact</span>
    <span class="ruby-comment"># Apply the findings, in case the recipe already existed</span>
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">decorate</span>.<span class="ruby-identifier">findings</span> = <span class="ruby-constant">FinderServices</span>.<span class="ruby-identifier">from_extractions</span> <span class="ruby-identifier">extractions</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 870</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_recipes_page</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div.recipe-collections__list a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">collection_link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">cpic</span> = <span class="ruby-identifier">collection_link</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">bbc_define_collection</span> <span class="ruby-identifier">collection_link</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div.recipe-collections__title&#39;</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">text</span>,
                          <span class="ruby-identifier">collection_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>),
                          (<span class="ruby-identifier">cpic</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">cpic</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_season_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_season_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_season_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 1164</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_season_home_page</span>
  <span class="ruby-identifier">month_name</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h1&#39;</span>).<span class="ruby-identifier">text</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/.*\s([-\w]*\z)/</span>, <span class="ruby-string">&#39;\1&#39;</span>
  <span class="ruby-comment"># month_tag = TagServices.define(month_name,</span>
  <span class="ruby-comment">#                                :tagtype =&gt; :Occasion,</span>
  <span class="ruby-comment">#                                :page_link =&gt; url)</span>
  <span class="ruby-identifier">month_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">month_name</span>, <span class="ruby-value">:Occasion</span>, <span class="ruby-identifier">url</span>
  <span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;Occasion&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">month_name</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#related-ingredients li a&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">page_link</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># ingred_tag = TagServices.define( page_link.text.downcase,</span>
    <span class="ruby-comment">#                                  :tagtype =&gt; :Ingredient,</span>
    <span class="ruby-comment">#                                  :page_link =&gt; absolutize(page_link))</span>
    <span class="ruby-identifier">ingred_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">page_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">downcase</span>, <span class="ruby-value">:Ingredient</span>, <span class="ruby-identifier">page_link</span>
    <span class="ruby-identifier">month_tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tr</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">tr</span>.<span class="ruby-identifier">ingredient_referents</span> = (<span class="ruby-identifier">tr</span>.<span class="ruby-identifier">ingredient_referents</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">ingred_tag</span>.<span class="ruby-identifier">referents</span>).<span class="ruby-identifier">uniq</span>
    }
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_seasons_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_seasons_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_seasons_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 796</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_seasons_page</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a.season-image&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">season_link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">tag_name</span> = <span class="ruby-identifier">season_link</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;span.season-name&#39;</span>).<span class="ruby-identifier">text</span>
    <span class="ruby-identifier">page_link</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">season_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>
    <span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">season_link</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>).<span class="ruby-identifier">to_s</span>
    <span class="ruby-comment"># TagServices.define tag_name, tagtype: &#39;Occasion&#39;, page_link: page_link, image_link: img_link</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tag_name</span>, <span class="ruby-value">:Occasion</span>, <span class="ruby-identifier">page_link</span>, <span class="ruby-identifier">image_link</span><span class="ruby-operator">:</span> <span class="ruby-identifier">img_link</span>
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!!!Scraper Defined Tag &#39;#{tag_name}&#39; -&gt; #{page_link} and image link #{img_link}&quot;</span>
    <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">page_link</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_tag_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_tag_recipes_page</span><span
            class="method-args">(tagtype)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>How to process a recipes page due to a search on a tag (after determining
the type of tag)</p>
          
          

          
          <div class="method-source-code" id="bbc_tag_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 533</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-identifier">tagtype</span>
  <span class="ruby-identifier">tag</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">typesym</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">typesym</span> <span class="ruby-identifier">tagtype</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">taghead</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h2&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">tagname</span> = <span class="ruby-identifier">taghead</span>.<span class="ruby-identifier">content</span>
    <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">downcase!</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:Dish</span>, <span class="ruby-value">:Course</span>, <span class="ruby-value">:Diet</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">typesym</span>)
    <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/\s*\.\s*$/</span>, <span class="ruby-string">&#39;&#39;</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">typesym</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:Ingredient</span>
        <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/^.*ecipes with keyword:?/i</span>, <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:Course</span>
        <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/^.*ecipes by course:?/i</span>, <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:Source</span>
        <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/^.*ecipes from/i</span>, <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:Author</span>
        <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/^.*ecipes by/i</span>, <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:Occasion</span>, <span class="ruby-value">:Dish</span>, <span class="ruby-value">:Diet</span>, <span class="ruby-value">:Genre</span>
        <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/\brecipes\s*(and menus)?\s*$/i</span>, <span class="ruby-string">&#39;&#39;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">strip!</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">url</span>.<span class="ruby-identifier">match</span> <span class="ruby-regexp">/page=/</span>
      <span class="ruby-identifier">link_text</span> = <span class="ruby-identifier">taghead</span>.<span class="ruby-identifier">content</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/\.\s*$/</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\s+/</span>, <span class="ruby-string">&#39; &#39;</span>)
      <span class="ruby-comment"># tag = TagServices.define tagname,</span>
      <span class="ruby-comment">#                          tagtype: typesym,</span>
      <span class="ruby-comment">#                          page_link: url,</span>
      <span class="ruby-comment">#                          link_text: link_text</span>
      <span class="ruby-identifier">tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tagname</span>, <span class="ruby-identifier">typesym</span>, <span class="ruby-identifier">url</span>, <span class="ruby-identifier">link_text</span><span class="ruby-operator">:</span> <span class="ruby-identifier">link_text</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">taglink</span> = <span class="ruby-identifier">taghead</span>.<span class="ruby-identifier">search</span> <span class="ruby-string">&#39;a&#39;</span> <span class="ruby-comment"># See if there&#39;s a link to the entity</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">taglink</span> = <span class="ruby-identifier">taglink</span>.<span class="ruby-identifier">first</span>
      <span class="ruby-comment"># tag = TagServices.define tagname,</span>
      <span class="ruby-comment">#                          tagtype: typesym,</span>
      <span class="ruby-comment">#                          page_link: absolutize(taglink)</span>
      <span class="ruby-identifier">tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tagname</span>, <span class="ruby-identifier">typesym</span>, <span class="ruby-identifier">taglink</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">extractions</span> = {}
  <span class="ruby-identifier">extractions</span>[<span class="ruby-identifier">tag</span>.<span class="ruby-identifier">typename</span>] = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#article-list li&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">recipe_item</span> <span class="ruby-identifier">li</span>, <span class="ruby-identifier">extractions</span>
  }
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">page</span>.<span class="ruby-identifier">links</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span> <span class="ruby-identifier">link</span>.<span class="ruby-identifier">rel?</span>(<span class="ruby-string">&#39;next&#39;</span>) }
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">url</span>.<span class="ruby-identifier">match</span> <span class="ruby-regexp">/[?&amp;]page=/</span> <span class="ruby-comment"># Only scrape the tags on the first page, and only courses</span>
    <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#filter-results div#courses-filters ul li&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">define_linked_tag</span> <span class="ruby-string">&#39;courses&#39;</span>, <span class="ruby-identifier">li</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">li</span>.<span class="ruby-identifier">content</span>.<span class="ruby-identifier">match</span> <span class="ruby-string">&#39;Other&#39;</span>)
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_technique_home_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_technique_home_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_technique_home_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 879</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_technique_home_page</span>
  <span class="ruby-identifier">author_tag</span> =
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">author_link</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span> <span class="ruby-string">&#39;div#chef-details h2 a&#39;</span>).<span class="ruby-identifier">present?</span>
        <span class="ruby-identifier">author_name</span> = <span class="ruby-identifier">author_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
        <span class="ruby-identifier">author_page</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">author_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">author_pic_link</span> = <span class="ruby-identifier">author_link</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>
          <span class="ruby-identifier">author_pic_link</span> = <span class="ruby-identifier">author_pic_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;src&#39;</span>).<span class="ruby-identifier">to_s</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># TagServices.define author_name, {</span>
        <span class="ruby-comment">#                                   :tagtype =&gt; :Author,</span>
        <span class="ruby-comment">#                                   :page_link =&gt; author_page,</span>
        <span class="ruby-comment">#                                   :image_link =&gt; author_pic_link</span>
        <span class="ruby-comment">#                               }.compact</span>
        <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">author_name</span>, <span class="ruby-value">:Author</span>, <span class="ruby-identifier">author_page</span>, <span class="ruby-value">:image_link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">author_pic_link</span>
      <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">technique_name</span> = <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#column-1 h1&#39;</span>).<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">downcase</span>
  <span class="ruby-comment"># technique_tag = TagServices.define technique_name, {</span>
  <span class="ruby-comment">#                                                      :tagtype =&gt; :Process,</span>
  <span class="ruby-comment">#                                                      :page_link =&gt; url,</span>
  <span class="ruby-comment">#                                                      :suggested_by =&gt; author_tag</span>
  <span class="ruby-comment">#                                                  }.compact</span>
  <span class="ruby-identifier">technique_tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">technique_name</span>, <span class="ruby-value">:Process</span>, <span class="ruby-identifier">url</span>, <span class="ruby-value">:suggested_by</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">author_tag</span>
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;div#information-box h2&#39;</span>, <span class="ruby-string">&#39;ul&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">header_text</span>, <span class="ruby-identifier">tool_li</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">toolname</span> = <span class="ruby-identifier">tool_li</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">downcase</span>
    <span class="ruby-comment"># TagServices.define toolname,</span>
    <span class="ruby-comment">#                    tagtype: &#39;Tool&#39;,</span>
    <span class="ruby-comment">#                    suggests: technique_tag if toolname.present? &amp;&amp; header_text == &#39;Equipment you will need for this technique&#39;</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">toolname</span>,
                           <span class="ruby-value">:Tool</span>,
                           <span class="ruby-identifier">suggests</span><span class="ruby-operator">:</span> <span class="ruby-identifier">technique_tag</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">toolname</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">header_text</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Equipment you will need for this technique&#39;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;div#overview h4&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h4</span><span class="ruby-operator">|</span> <span class="ruby-identifier">recipe_item</span> <span class="ruby-identifier">h4</span>, <span class="ruby-string">&#39;Process&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">technique_name</span> }

  <span class="ruby-identifier">accordions</span> <span class="ruby-string">&#39;div#recipes-list-module&#39;</span>, <span class="ruby-string">&#39;Process&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">technique_name</span>

  <span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a.see-all-search&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>), <span class="ruby-value">:bbc_technique_recipes_page</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_technique_recipes_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_technique_recipes_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_technique_recipes_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 586</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_technique_recipes_page</span>
  <span class="ruby-identifier">bbc_tag_recipes_page</span> <span class="ruby-value">:Process</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bbc_techniques_page" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bbc_techniques_page</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bbc_techniques_page-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 755</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bbc_techniques_page</span>
  <span class="ruby-identifier">header_tag_services</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">headered_list_items</span> <span class="ruby-string">&#39;dl dt&#39;</span>, <span class="ruby-string">&#39;dd&#39;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">header_name</span>, <span class="ruby-identifier">li</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">header_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Other&#39;</span>
      <span class="ruby-identifier">header_tag_services</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">header_tag_services</span> = <span class="ruby-constant">TagServices</span>.<span class="ruby-identifier">new</span>(
          <span class="ruby-comment"># TagServices.define header_name, tagtype: Tag.typenum(:Process)</span>
          <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">header_name</span>, <span class="ruby-value">:Process</span>
      ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">header_tag_services</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">header_tag_services</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">header_name</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">tech_link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">tag_name</span> = <span class="ruby-identifier">tech_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-identifier">page_link</span> = <span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">tech_link</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;href&#39;</span>).<span class="ruby-identifier">to_s</span>
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!!!Scraper Defined Tag Link for &#39;#{tag_name}&#39; -&gt; #{page_link}&quot;</span>
    <span class="ruby-comment"># tag = TagServices.define  tag_name,</span>
    <span class="ruby-comment">#                           tagtype: &#39;Process&#39;,</span>
    <span class="ruby-comment">#                           page_link: page_link</span>
    <span class="ruby-identifier">tag</span> = <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tag_name</span>, <span class="ruby-value">:Process</span>, <span class="ruby-identifier">page_link</span>
    <span class="ruby-identifier">header_tag_services</span>.<span class="ruby-identifier">make_parent_of</span> <span class="ruby-identifier">tag</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">header_tag_services</span>
    <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">page_link</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-define_linked_tag" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">define_linked_tag</span><span
            class="method-args">(header_name, li)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="define_linked_tag-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 618</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">define_linked_tag</span> <span class="ruby-identifier">header_name</span>, <span class="ruby-identifier">li</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-comment"># Translate from BBC tag types to the RP equivalent</span>
    <span class="ruby-identifier">tagname</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/^\s*Show\s*/</span>,<span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/\s*(recipes|\(\d*\)).*$/m</span>,<span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">strip</span>
    <span class="ruby-identifier">key_name_type</span> = <span class="ruby-identifier">header_name</span>.<span class="ruby-identifier">downcase</span>
    <span class="ruby-identifier">query</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">tagtype</span> =
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">key_name_type</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;dishes&#39;</span>
            <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">downcase!</span>
            <span class="ruby-value">:Dish</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;occasions&#39;</span>
            <span class="ruby-value">:Occasion</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;ingredients&#39;</span>
            <span class="ruby-identifier">key_name_type</span> = <span class="ruby-string">&#39;keywords&#39;</span>
            <span class="ruby-identifier">query</span> = <span class="ruby-node">&quot;keywords=#{tagname.downcase!}&quot;</span>
            <span class="ruby-value">:Ingredient</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;chefs&#39;</span>
            <span class="ruby-value">:Author</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;programmes&#39;</span>
            <span class="ruby-value">:Source</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;courses&#39;</span>
            <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">downcase!</span>
            <span class="ruby-value">:Course</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;special diets&#39;</span>
            <span class="ruby-identifier">key_name_type</span> = <span class="ruby-string">&#39;diets&#39;</span>
            <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">downcase!</span>
            <span class="ruby-value">:Diet</span>
          <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;cuisines&#39;</span>
            <span class="ruby-value">:Genre</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">link_text</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">unescape</span> <span class="ruby-identifier">link</span>[<span class="ruby-string">&#39;href&#39;</span>]
      <span class="ruby-identifier">tag_id</span> = <span class="ruby-keyword">nil</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">link_text</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/\/food\/([-\w]*$)/</span>)
        <span class="ruby-identifier">tag_id</span> = <span class="ruby-node">$1</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-comment"># Get the last reference to this key_name_type in the link</span>
        <span class="ruby-keyword">while</span> <span class="ruby-identifier">link_text</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-node">/#{key_name_type}((\[[^\]]*\])?=|\/)([^&amp;]*)/</span>, <span class="ruby-string">&#39;&#39;</span>)
          <span class="ruby-identifier">tag_id</span> = <span class="ruby-node">$3</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag_id</span>
        <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">absolutize</span>(<span class="ruby-node">&quot;/food/#{tag_id}&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">tagtype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Dish</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">tagtype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Ingredient</span>  <span class="ruby-comment"># Most home pages can be reached via indexing, but not Dishes&#39;</span>
        <span class="ruby-identifier">query</span> <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;#{key_name_type}[]=#{tag_id}&quot;</span>
        <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">absolutize</span>(<span class="ruby-node">&quot;/food/recipes/search?#{query}&quot;</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">x</span>=<span class="ruby-value">2</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># TagServices.define tagname, :tagtype =&gt; Tag.typenum(tagtype) if tagtype</span>
    <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span> <span class="ruby-identifier">tagname</span>, <span class="ruby-identifier">tagtype</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tagtype</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-headered_list_items" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">headered_list_items</span><span
            class="method-args">(header_selector, sibling_tag='ul', title=nil, &block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Process the items of a list that is preceded by a header</p>
          
          

          
          <div class="method-source-code" id="headered_list_items-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 809</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">headered_list_items</span> <span class="ruby-identifier">header_selector</span>, <span class="ruby-identifier">sibling_tag</span>=<span class="ruby-string">&#39;ul&#39;</span>, <span class="ruby-identifier">title</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>
  (<span class="ruby-identifier">page</span>.<span class="ruby-identifier">search</span>(<span class="ruby-identifier">header_selector</span>)).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hdr</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">hdr_text</span> = <span class="ruby-identifier">hdr</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-comment"># Cycle through the following siblings of the header element in search of the</span>
    <span class="ruby-comment"># one matching the sibling_tag. Terminate when another header tag appears</span>
    <span class="ruby-identifier">div</span> = <span class="ruby-identifier">hdr</span>.<span class="ruby-identifier">next_element</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">div</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">div</span>.<span class="ruby-identifier">matches?</span> <span class="ruby-identifier">header_selector</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">div</span>.<span class="ruby-identifier">matches?</span> <span class="ruby-identifier">sibling_tag</span>
        <span class="ruby-identifier">div</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;li&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">li</span><span class="ruby-operator">|</span> <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span> <span class="ruby-identifier">hdr_text</span>, <span class="ruby-identifier">li</span> } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">title</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">title</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">hdr_text</span>)
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">div</span> = <span class="ruby-identifier">div</span>.<span class="ruby-identifier">next_element</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># hdr.search(&quot;~ #{sibling_tag}:first li&quot;).each { |li| block.call hdr_text, li } unless title &amp;&amp; (title != hdr_text)</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-recipe_item" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">recipe_item</span><span
            class="method-args">(li, extractions_from_context={})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="recipe_item-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 321</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">recipe_item</span> <span class="ruby-identifier">li</span>, <span class="ruby-identifier">extractions_from_context</span>={}
  <span class="ruby-comment"># Clone the extractions, ensuring that keys are strings</span>
  <span class="ruby-identifier">extractions</span> = {}
  <span class="ruby-identifier">extractions_from_context</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-identifier">extractions</span>[<span class="ruby-identifier">key</span>.<span class="ruby-identifier">to_s</span>] = <span class="ruby-identifier">value</span> }
  <span class="ruby-identifier">recipe_link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">recipe_link</span>[<span class="ruby-string">&#39;href&#39;</span>].<span class="ruby-identifier">match</span> <span class="ruby-regexp">/food\/recipes\//</span>
  <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Title&#39;</span>] = <span class="ruby-identifier">recipe_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">img_link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Image&#39;</span>] = <span class="ruby-identifier">registrar</span>.<span class="ruby-identifier">absolutize</span> <span class="ruby-identifier">img_link</span>, <span class="ruby-value">:src</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">chef_name</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;span.chef-name&#39;</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Author&#39;</span>] = <span class="ruby-identifier">chef_name</span>.<span class="ruby-identifier">text</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;h4&#39;</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">hdr</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">match</span> = <span class="ruby-identifier">hdr</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/^(By|From|Preparation time:|Cooking time:|Serves)\s*(\w.*)$/</span>)
      <span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">strip</span>, <span class="ruby-identifier">match</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">key</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/\s.*/</span>, <span class="ruby-string">&#39;&#39;</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;By&#39;</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Author&#39;</span>] = <span class="ruby-identifier">value</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;From&#39;</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Source&#39;</span>] = <span class="ruby-identifier">value</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;Preparation&#39;</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Prep Time&#39;</span>] = <span class="ruby-identifier">value</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;Cooking&#39;</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Cooking Time&#39;</span>] = <span class="ruby-identifier">value</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;Serves&#39;</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Yield&#39;</span>] = <span class="ruby-identifier">labelled_quantity</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-string">&#39;Serving&#39;</span>, <span class="ruby-string">&#39;&#39;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">cl</span> = <span class="ruby-identifier">hdr</span>.<span class="ruby-identifier">attribute</span>(<span class="ruby-string">&#39;class&#39;</span>)) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">cl</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;icon&#39;</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">link</span> = <span class="ruby-identifier">hdr</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">link</span>[<span class="ruby-string">&#39;href&#39;</span>].<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/\A\/food\/(\w*)\/([-\w]*)\z/</span>)
        <span class="ruby-identifier">bbc_type</span>, <span class="ruby-identifier">name</span> = <span class="ruby-node">$1</span>, <span class="ruby-node">$2</span>
        <span class="ruby-identifier">rp_type</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">bbc_type</span>
                    <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;seasons&#39;</span>
                      <span class="ruby-identifier">name</span>.<span class="ruby-identifier">capitalize!</span>
                      <span class="ruby-string">&#39;Occasion&#39;</span>
                    <span class="ruby-keyword">else</span>
                      <span class="ruby-identifier">bbc_type</span>.<span class="ruby-identifier">capitalize</span>.<span class="ruby-identifier">singularize</span>
                  <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">extractions</span>[<span class="ruby-identifier">rp_type</span>].<span class="ruby-identifier">present?</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-identifier">rp_type</span>.<span class="ruby-identifier">pluralize</span>] = <span class="ruby-node">&quot;#{extractions.delete rp_type}, #{name}&quot;</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-identifier">rp_type</span>] = <span class="ruby-identifier">name</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">hdr</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;span.quick-and-easy&#39;</span>).<span class="ruby-identifier">first</span>
          <span class="ruby-comment"># Icon denoting &#39;quick and easy recipes&#39;</span>
          <span class="ruby-identifier">extractions</span>[<span class="ruby-string">&#39;Total Time&#39;</span>] = <span class="ruby-string">&#39;Under a half hour&#39;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_recipe</span> <span class="ruby-identifier">recipe_link</span>, <span class="ruby-identifier">extractions</span>.<span class="ruby-identifier">compact</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tag_def_label" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tag_def_label</span><span
            class="method-args">(result_type, typesym, tagname)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="tag_def_label-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 526</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tag_def_label</span> <span class="ruby-identifier">result_type</span>, <span class="ruby-identifier">typesym</span>, <span class="ruby-identifier">tagname</span>
  <span class="ruby-identifier">label</span> = <span class="ruby-constant">ApplicationController</span>.<span class="ruby-identifier">helpers</span>.<span class="ruby-identifier">t</span>(<span class="ruby-node">&quot;definition_reference.label.tag.#{typesym}&quot;</span>, <span class="ruby-identifier">entity_type</span><span class="ruby-operator">:</span> <span class="ruby-identifier">result_type</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">pluralize</span>, <span class="ruby-identifier">tagname</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tagname</span>)
  <span class="ruby-identifier">label</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">label</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">upcase</span>
  <span class="ruby-identifier">label</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tag_item" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tag_item</span><span
            class="method-args">(li, tagtype=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Scrape the definition of a tag, and the link to the tag&#39;s page</p>
          
          

          
          <div class="method-source-code" id="tag_item-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 376</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tag_item</span> <span class="ruby-identifier">li</span>, <span class="ruby-identifier">tagtype</span>=<span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">entity_link</span> = <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;a&#39;</span>).<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">scrape</span> <span class="ruby-identifier">entity_link</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">recur</span>
  <span class="ruby-identifier">tagname</span> = <span class="ruby-identifier">entity_link</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">tagtype</span>
    <span class="ruby-comment"># Dishes and ingredients are downcased</span>
    <span class="ruby-identifier">tagname</span> = <span class="ruby-identifier">tagname</span>.<span class="ruby-identifier">downcase</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">tagtype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Dish</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">tagtype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:Ingredient</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">tagtype</span> =
        <span class="ruby-comment"># How to tag the link depends on what the target page denotes</span>
        <span class="ruby-comment"># For that, we depend on the #handler method parsing the URL to tell us what kind of link it is</span>
        <span class="ruby-keyword">case</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">handler</span>(<span class="ruby-identifier">entity_link</span>)
          <span class="ruby-keyword">when</span> <span class="ruby-value">:bbc_chef_home_page</span>
            <span class="ruby-value">:Author</span>
          <span class="ruby-keyword">when</span> <span class="ruby-value">:bbc_occasion_home_page</span>
            <span class="ruby-value">:Occasion</span>
          <span class="ruby-keyword">when</span> <span class="ruby-value">:bbc_cuisine_home_page</span>
            <span class="ruby-value">:Genre</span>
          <span class="ruby-keyword">when</span> <span class="ruby-value">:bbc_season_home_page</span>
            <span class="ruby-value">:Occasion</span>
        <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># if img_link = li.search(&#39;img&#39;).first</span>
  <span class="ruby-comment">#   img_link = absolutize img_link, :src</span>
  <span class="ruby-comment"># end</span>
  <span class="ruby-comment"># These are home pages, so they&#39;ll just be given the name of the tag</span>
  <span class="ruby-comment"># TagServices.define(tagname,</span>
  <span class="ruby-comment">#                    tagtype: Tag.typenum(tagtype),</span>
  <span class="ruby-comment">#                    page_link: absolutize(entity_link),</span>
  <span class="ruby-comment">#                    image_link: img_link) if tagtype</span>
  <span class="ruby-constant">Registrar</span>.<span class="ruby-identifier">register_tag</span>(<span class="ruby-identifier">tagname</span>, <span class="ruby-identifier">tagtype</span>, <span class="ruby-identifier">entity_link</span>, <span class="ruby-identifier">image_link</span><span class="ruby-operator">:</span> <span class="ruby-identifier">li</span>.<span class="ruby-identifier">search</span>(<span class="ruby-string">&#39;img&#39;</span>).<span class="ruby-identifier">first</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">tagtype</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tidy_name" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tidy_name</span><span
            class="method-args">(name, typesym)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="tidy_name-source">
            <pre><span class="ruby-comment"># File app/models/scraper.rb, line 521</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tidy_name</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">typesym</span>
  <span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase!</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:Dish</span>, <span class="ruby-value">:Course</span>, <span class="ruby-value">:Diet</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">typesym</span>)
  <span class="ruby-identifier">name</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\b\s*recipes$/</span>, <span class="ruby-string">&#39;&#39;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

