<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class Referent - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">ActiveRecord::Base
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="Picable.html">Picable</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li class="calls-super" ><a href="#method-c-create">::create</a>
    
    <li ><a href="#method-c-dump">::dump</a>
    
    <li ><a href="#method-c-express">::express</a>
    
    <li ><a href="#method-c-find_by_tag">::find_by_tag</a>
    
    <li ><a href="#method-c-referent_class_for_tagtype">::referent_class_for_tagtype</a>
    
    <li ><a href="#method-c-related">::related</a>
    
    <li ><a href="#method-c-show_tree">::show_tree</a>
    
    <li ><a href="#method-c-strscopes">::strscopes</a>
    
    <li ><a href="#method-c-type_to_class">::type_to_class</a>
    
    <li ><a href="#method-i-absorb">#absorb</a>
    
    <li ><a href="#method-i-add_expression">#add_expression</a>
    
    <li ><a href="#method-i-add_expression-3D">#add_expression=</a>
    
    <li ><a href="#method-i-associate">#associate</a>
    
    <li ><a href="#method-i-child_tags">#child_tags</a>
    
    <li ><a href="#method-i-child_tokens">#child_tokens</a>
    
    <li ><a href="#method-i-child_tokens-3D">#child_tokens=</a>
    
    <li ><a href="#method-i-drop">#drop</a>
    
    <li ><a href="#method-i-dump">#dump</a>
    
    <li ><a href="#method-i-ensure_tagtypes">#ensure_tagtypes</a>
    
    <li ><a href="#method-i-express">#express</a>
    
    <li ><a href="#method-i-expression">#expression</a>
    
    <li ><a href="#method-i-fix_references">#fix_references</a>
    
    <li ><a href="#method-i-longname">#longname</a>
    
    <li ><a href="#method-i-make_parent_of">#make_parent_of</a>
    
    <li ><a href="#method-i-name">#name</a>
    
    <li ><a href="#method-i-names">#names</a>
    
    <li ><a href="#method-i-normalized_name">#normalized_name</a>
    
    <li ><a href="#method-i-parent_tags">#parent_tags</a>
    
    <li ><a href="#method-i-parent_tokens">#parent_tokens</a>
    
    <li ><a href="#method-i-parent_tokens-3D">#parent_tokens=</a>
    
    <li ><a href="#method-i-paths_to">#paths_to</a>
    
    <li ><a href="#method-i-suggests">#suggests</a>
    
    <li ><a href="#method-i-suggests-3F">#suggests?</a>
    
    <li ><a href="#method-i-tag_tokens_to_referents">#tag_tokens_to_referents</a>
    
    <li ><a href="#method-i-tags_from_referents">#tags_from_referents</a>
    
    <li ><a href="#method-i-typename">#typename</a>
    
    <li ><a href="#method-i-typenum">#typenum</a>
    
    <li ><a href="#method-i-typesym">#typesym</a>
    
    <li class="calls-super" ><a href="#method-i-update_attributes">#update_attributes</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Referent">
  <h1 id="class-Referent" class="class">
    class Referent
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-dependent" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">dependent</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-create" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create</span><span
            class="method-args">(*params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="create-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 341</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">parentid</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">parentid</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">first</span>[<span class="ruby-value">:parent_id</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">first</span>[<span class="ruby-value">:parent_id</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
    <span class="ruby-comment"># params.first.delete :parent_id # closure_tree will add the parent</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">result</span> = <span class="ruby-keyword">super</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">parentid</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
    <span class="ruby-comment"># We give the new node a parent</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">parent</span> = <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">parentid</span>)
      <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">add_child</span> <span class="ruby-identifier">result</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-dump" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">dump</span><span
            class="method-args">(tagtype=4)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Dump the contents of the database to stdout</p>
          
          

          
          <div class="method-source-code" id="dump-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">tagtype</span>=<span class="ruby-value">4</span>
  <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">parents</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">ref</span>.<span class="ruby-identifier">typenum</span><span class="ruby-operator">==</span><span class="ruby-identifier">tagtype</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ref</span> }.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tl</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tl</span>.<span class="ruby-identifier">dump</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tl</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-express" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">express</span><span
            class="method-args">(tag, tagtype = nil, args = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Class method to create a referent of a given type under the given tag, or
to find an existing one. WARNING: while some effort is made to find an
existing referent and use that,</p>

<pre>this procedure lends itself to redundancy in the dictionary</pre>
          
          

          
          <div class="method-source-code" id="express-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 244</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">express</span> (<span class="ruby-identifier">tag</span>, <span class="ruby-identifier">tagtype</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">args</span> = {})
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Tag</span> <span class="ruby-comment"># Creating it if need be, and/or making it global</span>
    <span class="ruby-identifier">tagtype</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">tag</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">assert</span>(<span class="ruby-identifier">tag</span>, <span class="ruby-identifier">tagtype</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tagtype</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">ref</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">primary_meaning</span> <span class="ruby-operator">||</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span>
      <span class="ruby-comment"># We don&#39;t immediately have a referent for this tag</span>
      <span class="ruby-comment">#...but there may already be one as a plural or a singular</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">primary_meaning</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">first</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span>
      <span class="ruby-comment"># Tag doesn&#39;t have an existing referent, so need to make one</span>
      <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">referent_class_for_tagtype</span>(<span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span>).<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">tag_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">id</span> <span class="ruby-comment"># Successfully created</span>
    <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">tag</span>, <span class="ruby-identifier">args</span>
    <span class="ruby-identifier">ref</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-find_by_tag" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_by_tag</span><span
            class="method-args">(tag, tagtype)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Find a referent from a tag string of a given type. This is a search for ANY
tag that refers to the the referent, not just the canonical one</p>
          
          

          
          <div class="method-source-code" id="find_by_tag-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 405</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_by_tag</span> <span class="ruby-identifier">tag</span>, <span class="ruby-identifier">tagtype</span>
  <span class="ruby-comment"># Find or create the tag</span>

  <span class="ruby-comment"># We now have a list of qualifying tags. Choose the one which has</span>
  <span class="ruby-comment"># an existing referent, if any</span>

  <span class="ruby-comment"># Find or create an appropriate referent for the tag</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-referent_class_for_tagtype" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">referent_class_for_tagtype</span><span
            class="method-args">(typenum)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="referent_class_for_tagtype-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 236</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">referent_class_for_tagtype</span>(<span class="ruby-identifier">typenum</span>)
  (((<span class="ruby-identifier">typenum</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">?</span> <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">typesym</span>(<span class="ruby-identifier">typenum</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">:</span> <span class="ruby-string">&#39;&#39;</span>)<span class="ruby-operator">+</span><span class="ruby-string">&#39;Referent&#39;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-related" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">related</span><span
            class="method-args">(tag, doSynonyms = false, doParents = false, doChildren = false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return a list of all tags that are related to the one provided. This means:
地ll the synonyms (if required) and 地ll the parents (if required) of 地ll
the children (if required) of 地ll the referents of this tag</p>
          
          

          
          <div class="method-source-code" id="related-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 303</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">related</span> <span class="ruby-identifier">tag</span>, <span class="ruby-identifier">doSynonyms</span> = <span class="ruby-keyword">false</span>, <span class="ruby-identifier">doParents</span> = <span class="ruby-keyword">false</span>, <span class="ruby-identifier">doChildren</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">unique_referents</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref</span><span class="ruby-operator">|</span>
    [(<span class="ruby-identifier">ref</span>.<span class="ruby-identifier">parents</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">doParents</span>), (<span class="ruby-identifier">ref</span>.<span class="ruby-identifier">children</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">doChildren</span>)]
  }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>
  <span class="ruby-identifier">tag_ids</span> = <span class="ruby-identifier">unique_referents</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">tag_id</span> }
  <span class="ruby-identifier">tag_ids</span> = <span class="ruby-identifier">tag_ids</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">tag_id</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">doSynonyms</span>
  <span class="ruby-identifier">tag_ids</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">id</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-show_tree" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">show_tree</span><span
            class="method-args">(key = nil, level = 0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="show_tree-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 328</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">show_tree</span>(<span class="ruby-identifier">key</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">level</span> = <span class="ruby-value">0</span>)
  <span class="ruby-identifier">children</span> = []
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">key</span>
    <span class="ruby-identifier">ref</span> = <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">key</span>
    <span class="ruby-identifier">puts</span> (<span class="ruby-string">&quot;    &quot;</span><span class="ruby-operator">*</span><span class="ruby-identifier">level</span>)<span class="ruby-operator">+</span><span class="ruby-node">&quot;#{ref.id.to_s}: #{ref.name} (#{ref.tag_id})&quot;</span>
    <span class="ruby-identifier">children</span> = <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">children</span>
    <span class="ruby-identifier">level</span> = <span class="ruby-identifier">level</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">children</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">roots</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">show_tree</span> <span class="ruby-identifier">child</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">level</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-strscopes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">strscopes</span><span
            class="method-args">(matcher) { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="strscopes-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 91</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">strscopes</span> <span class="ruby-identifier">matcher</span>
  [
      (<span class="ruby-identifier">block_given?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">yield</span>() <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:tags</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;&quot;tags&quot;.&quot;name&quot; ILIKE ?&#39;</span>, <span class="ruby-identifier">matcher</span>)
  ]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-type_to_class" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">type_to_class</span><span
            class="method-args">(type)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="type_to_class-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 312</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">type_to_class</span> <span class="ruby-identifier">type</span>
  (<span class="ruby-identifier">type</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">type</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">typesym</span>(<span class="ruby-identifier">type</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-constant">Tag</span>.<span class="ruby-identifier">typesym</span>(<span class="ruby-identifier">type</span>).<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&quot;Referent&quot;</span>).<span class="ruby-identifier">constantize</span>) <span class="ruby-operator">||</span> <span class="ruby-constant">Referent</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-absorb" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">absorb</span><span
            class="method-args">(other, nuke_it=true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="absorb-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 97</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">absorb</span> <span class="ruby-identifier">other</span>, <span class="ruby-identifier">nuke_it</span>=<span class="ruby-keyword">true</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">type</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">id</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;Merging &#39;&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">name</span><span class="ruby-operator">+</span><span class="ruby-node">&quot;&#39; (#{children.count} children) with &#39;&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">other</span>.<span class="ruby-identifier">name</span><span class="ruby-operator">+</span><span class="ruby-node">&quot;&#39; (#{other.children.count} children):&quot;</span>
  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span> <span class="ruby-identifier">children</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">child</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">child_ids</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">child</span>.<span class="ruby-identifier">id</span>) }
  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">parents</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">parent</span><span class="ruby-operator">|</span> <span class="ruby-identifier">parents</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">parent</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">parent_ids</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">id</span>) }
  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">expressions</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">expr</span><span class="ruby-operator">|</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">tag</span> }
  <span class="ruby-comment"># Whatever entities can be reached through referments, copy those</span>
  <span class="ruby-identifier">@@referment_associations</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">assoc</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">collection_method</span> = <span class="ruby-identifier">assoc</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">underscore</span>.<span class="ruby-identifier">pluralize</span>.<span class="ruby-identifier">to_sym</span>
    <span class="ruby-identifier">collection</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">method</span>(<span class="ruby-identifier">collection_method</span>).<span class="ruby-identifier">call</span>
    <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">collection</span>.<span class="ruby-identifier">pluck</span> <span class="ruby-value">:id</span>
    <span class="ruby-identifier">other</span>.<span class="ruby-identifier">method</span>(<span class="ruby-identifier">collection_method</span>).<span class="ruby-identifier">call</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">entity</span><span class="ruby-operator">|</span> <span class="ruby-identifier">collection</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">entity</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">ids</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">entity</span>.<span class="ruby-identifier">id</span>) }
  }
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">description</span> = <span class="ruby-identifier">other</span>.<span class="ruby-identifier">description</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">description</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">nuke_it</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-add_expression" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_expression</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>This is a virtual attribute for the benefit of the referent editor, which
has a tokenInput field for adding expressions. In reality, there should
never be any text in this field when the form is submitted. If there is, we
just ignore it</p>
          
          

          
          <div class="method-source-code" id="add_expression-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 182</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_expression</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-add_expression-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_expression=</span><span
            class="method-args">(tag)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="add_expression-3D-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_expression=</span>(<span class="ruby-identifier">tag</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-associate" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">associate</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The associate is the model associated with any particular class of
referent, if any By default, referents have no associate; currently,
Sources have one</p>
          
          

          
          <div class="method-source-code" id="associate-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 137</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">associate</span>
  <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-child_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">child_tags</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="child_tags-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 209</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">child_tags</span>
  <span class="ruby-identifier">tags_from_referents</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">children</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-child_tokens" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">child_tokens</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="child_tokens-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 205</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">child_tokens</span>
  <span class="ruby-identifier">child_tags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:attributes</span>).<span class="ruby-identifier">to_json</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-child_tokens-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">child_tokens=</span><span
            class="method-args">(tokenlist)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="child_tokens-3D-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 213</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">child_tokens=</span>(<span class="ruby-identifier">tokenlist</span>)
  <span class="ruby-comment"># After collecting tags, scan list to eliminate references to self</span>
  <span class="ruby-identifier">tokenlist</span> = <span class="ruby-identifier">tokenlist</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">children</span> = <span class="ruby-identifier">tag_tokens_to_referents</span>(<span class="ruby-identifier">tokenlist</span>).<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">rel</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">rel</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:children</span>, <span class="ruby-string">&quot;Can&#39;t be its own child.&quot;</span>) }.<span class="ruby-identifier">uniq</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-drop" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">drop</span><span
            class="method-args">(tag)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Remove uses of this tag by this referent</p>
          
          

          
          <div class="method-source-code" id="drop-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 415</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">drop</span> <span class="ruby-identifier">tag</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tag_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-comment"># Need to find another tag to use for canonical string</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">replacement_tag</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">candidate</span><span class="ruby-operator">|</span> <span class="ruby-identifier">candidate</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span> }
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">canonical_expression</span> = <span class="ruby-identifier">replacement_tag</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">tag</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-dump" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">dump</span><span
            class="method-args">(indent = "", path = [])</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Dump a specified referent with the given indent</p>
          
          

          
          <div class="method-source-code" id="dump-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 147</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">dump</span> <span class="ruby-identifier">indent</span> = <span class="ruby-string">&quot;&quot;</span>, <span class="ruby-identifier">path</span> = []
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">path</span>.<span class="ruby-identifier">include?</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{indent}!!Loop back to #{self.id.to_s}: #{self.name}&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{indent}Referent #{self.id.to_s}: #{self.name}&quot;</span>
    <span class="ruby-identifier">indent</span> = <span class="ruby-identifier">indent</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;    &quot;</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{indent}Tag #{tag.id.to_s}: #{tag.name}&quot;</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">links</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span> <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{indent}    Link #{link.id.to_s}: #{link.uri}&quot;</span> }
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span> <span class="ruby-identifier">child</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">indent</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">+</span>[<span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>]) }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ensure_tagtypes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_tagtypes</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>After saving, check that all tags are of our type</p>
          
          

          
          <div class="method-source-code" id="ensure_tagtypes-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 162</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_tagtypes</span>
  <span class="ruby-identifier">mytype</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">typenum</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># Ensure that all associated tags have the right type, are global, and have a meaning</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">mytype</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">isGlobal</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">mytype</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-comment"># ERROR!! Can&#39;t convert tag from another type</span>
        <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:tags</span>, <span class="ruby-node">&quot;#{tag.name} is a &#39;#{tag.typename}&#39;, not &#39;#{Tag.typename(mytype)}&#39;&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">tagtype</span> = <span class="ruby-identifier">mytype</span>
        <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">primary_meaning</span> = <span class="ruby-keyword">self</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">primary_meaning</span> <span class="ruby-comment"># Give tag this meaning if there&#39;s no other</span>
        <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">isGlobal</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-express" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">express</span><span
            class="method-args">(tag, args = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Add a tag to the expressions of this referent, returning the tag id</p>
          
          

          
          <div class="method-source-code" id="express-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 264</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">express</span>(<span class="ruby-identifier">tag</span>, <span class="ruby-identifier">args</span> = {})
  <span class="ruby-comment"># We assert the tag in case it&#39;s</span>
  <span class="ruby-comment"># 1) specified by string or id, rather than a tag object</span>
  <span class="ruby-comment"># 2) of a different type, or</span>
  <span class="ruby-comment"># 3) not already global</span>
  <span class="ruby-identifier">name</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">tag</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span>
  <span class="ruby-identifier">tag</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">assert</span> <span class="ruby-identifier">tag</span>, <span class="ruby-identifier">tagtype</span><span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">typenum</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">name</span>
    <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span> <span class="ruby-comment"># We may be setting the name to something that matches an existing tag</span>
    <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Promote the tag to the canonical expression on this referent if needed</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">args</span>[<span class="ruby-value">:form</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:generic</span>) <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">canonical_expression</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">canonical_expression</span> = <span class="ruby-identifier">tag</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Find or create an expression of this referent on this tag. If locale</span>
  <span class="ruby-comment"># or form aren&#39;t specified, match any expression</span>
  <span class="ruby-identifier">args</span>[<span class="ruby-value">:form</span>] = <span class="ruby-constant">Expression</span>.<span class="ruby-identifier">formnum</span>(<span class="ruby-value">:generic</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>[<span class="ruby-value">:form</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-constant">Expression</span>.<span class="ruby-identifier">find_or_create</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">args</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expressions</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-comment"># We&#39;re not saved, so have no id</span>
    <span class="ruby-identifier">args</span>[<span class="ruby-value">:tag_id</span>] = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-identifier">expr</span> = <span class="ruby-constant">Expression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">args</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expressions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">expr</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Point the tag back at this referent, if needed</span>
  <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">admit_meaning</span>(<span class="ruby-keyword">self</span>)
  <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-expression" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">expression</span><span
            class="method-args">(args = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return the tag expressing this referent according to the given form and
locale, if any</p>
          
          

          
          <div class="method-source-code" id="expression-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 426</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">expression</span>(<span class="ruby-identifier">args</span> = {})
  <span class="ruby-identifier">args</span> = <span class="ruby-constant">Expression</span>.<span class="ruby-identifier">scrub_args</span> <span class="ruby-identifier">args</span>
  ((<span class="ruby-identifier">args</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">expr</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expressions</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">args</span>).<span class="ruby-identifier">first</span>)) <span class="ruby-operator">?</span>
      <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">tag</span> <span class="ruby-operator">:</span>
      <span class="ruby-identifier">canonical_expression</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-fix_references" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">fix_references</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Callback before destroying this referent, to fix any tags that use it as
primary meaning</p>
          
          

          
          <div class="method-source-code" id="fix_references-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 118</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">fix_references</span>
  <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">primary_meaning</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">self</span>
      <span class="ruby-comment"># Choose a new primary meaning</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">referents</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">referent</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">referent</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">self</span>
          <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">primary_meaning</span> = <span class="ruby-identifier">referent</span>
          <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">save</span>
          <span class="ruby-keyword">return</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">primary_meaning</span> = <span class="ruby-keyword">nil</span>
      <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-longname" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">longname</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return the name, appended with all associated forms</p>
          
          

          
          <div class="method-source-code" id="longname-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 449</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">longname</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">name</span>
  <span class="ruby-identifier">aliases</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tag_id</span> }.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;(#{aliases})&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-make_parent_of" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">make_parent_of</span><span
            class="method-args">(child_ref)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="make_parent_of-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 456</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">make_parent_of</span> <span class="ruby-identifier">child_ref</span>
  <span class="ruby-identifier">children</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">child_ref</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">children</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">child_ref</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-name" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">name</span><span
            class="method-args">(args = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return the name of the referent</p>
          
          

          
          <div class="method-source-code" id="name-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 439</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">name</span>(<span class="ruby-identifier">args</span> = {})
  (<span class="ruby-identifier">tag</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expression</span> <span class="ruby-identifier">args</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;**no tag**&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-names" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">names</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Provide an array of all the names of all the tags for this referent</p>
          
          

          
          <div class="method-source-code" id="names-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 444</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">names</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expressions</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-normalized_name" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">normalized_name</span><span
            class="method-args">(args = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return the name of the referent</p>
          
          

          
          <div class="method-source-code" id="normalized_name-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 434</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">normalized_name</span>(<span class="ruby-identifier">args</span> = {})
  (<span class="ruby-identifier">tag</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expression</span> <span class="ruby-identifier">args</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">normalized_name</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;**no tag**&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-parent_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parent_tags</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="parent_tags-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 195</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parent_tags</span>
  <span class="ruby-identifier">tags_from_referents</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parents</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-parent_tokens" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parent_tokens</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Virtual attributes for parent and child referents. These are represented by
tags, so getting and setting involves token lookup. Since parents and
children are both just sets of referents, these v.a.s go through a single
pair of methods</p>
          
          

          
          <div class="method-source-code" id="parent_tokens-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 191</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parent_tokens</span>
  <span class="ruby-identifier">parent_tags</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:attributes</span>).<span class="ruby-identifier">to_json</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-parent_tokens-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parent_tokens=</span><span
            class="method-args">(tokenlist)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="parent_tokens-3D-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 199</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parent_tokens=</span>(<span class="ruby-identifier">tokenlist</span>)
  <span class="ruby-comment"># After collecting tags, scan list to eliminate references to self</span>
  <span class="ruby-identifier">tokenlist</span> = <span class="ruby-identifier">tokenlist</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parents</span> = <span class="ruby-identifier">tag_tokens_to_referents</span>(<span class="ruby-identifier">tokenlist</span>).<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">rel</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">rel</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:parents</span>, <span class="ruby-string">&#39;Can\t be its own parent.&#39;</span>) }.<span class="ruby-identifier">uniq</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-paths_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">paths_to</span><span
            class="method-args">(inText = true, collected = [])</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return an array of all paths leading to this leaf node</p>
          
          

          
          <div class="method-source-code" id="paths_to-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 360</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">paths_to</span> <span class="ruby-identifier">inText</span> = <span class="ruby-keyword">true</span>, <span class="ruby-identifier">collected</span> = []
  <span class="ruby-identifier">paths</span> = []
  (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent_ids</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">collected</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_id</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">parent</span> = <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">parent_id</span>
    <span class="ruby-identifier">paths</span> = <span class="ruby-identifier">paths</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">paths_to</span>(<span class="ruby-keyword">false</span>, <span class="ruby-identifier">collected</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">id</span>])
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">paths</span> = <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">?</span> [[<span class="ruby-keyword">self</span>]] <span class="ruby-operator">:</span> <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-identifier">path</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">self</span> }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">paths</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">inText</span>
  <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-identifier">path</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">name</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;/&#39;</span>) }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-suggests" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">suggests</span><span
            class="method-args">(target_ref)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="suggests-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 460</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">suggests</span> <span class="ruby-identifier">target_ref</span>
  <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">save</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-comment"># author_referents &lt;&lt; target_ref unless author_referents.include?(target_ref)</span>
  <span class="ruby-identifier">referments</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">referee_type</span><span class="ruby-operator">:</span> <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">referee_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">id</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">referments</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">referee_type</span><span class="ruby-operator">:</span> <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">referee_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">exists?</span>
  <span class="ruby-identifier">x</span>=<span class="ruby-value">2</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-suggests-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">suggests?</span><span
            class="method-args">(target_ref)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="suggests-3F-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 467</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">suggests?</span> <span class="ruby-identifier">target_ref</span>
  <span class="ruby-identifier">referments</span>.<span class="ruby-identifier">exists?</span> <span class="ruby-identifier">referee_type</span><span class="ruby-operator">:</span> <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">type</span>, <span class="ruby-identifier">referee_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">target_ref</span>.<span class="ruby-identifier">id</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tag_tokens_to_referents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tag_tokens_to_referents</span><span
            class="method-args">(tokens, use_existing=true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert a list of tag tokens into the referents to which they refer</p>
          
          

          
          <div class="method-source-code" id="tag_tokens_to_referents-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 225</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tag_tokens_to_referents</span>(<span class="ruby-identifier">tokens</span>, <span class="ruby-identifier">use_existing</span>=<span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">refs</span> = <span class="ruby-identifier">tokens</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">token</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># We either match the referent to token or create a new one</span>
    <span class="ruby-identifier">token</span>.<span class="ruby-identifier">strip!</span>
    <span class="ruby-identifier">token</span> = <span class="ruby-identifier">token</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">token</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/^\(.*)\$/</span>, <span class="ruby-string">&#39;\1&#39;</span>)
    <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">token</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">typenum</span>
  }.<span class="ruby-identifier">compact</span> <span class="ruby-comment"># Blow off failed referents</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&#39;Tokens converted to referents: &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">refs</span>.<span class="ruby-identifier">inspect</span>
  <span class="ruby-identifier">refs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tags_from_referents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tags_from_referents</span><span
            class="method-args">(referents)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert a list of referents into the tags that reference them.</p>
          
          

          
          <div class="method-source-code" id="tags_from_referents-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 220</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tags_from_referents</span>(<span class="ruby-identifier">referents</span>)
  <span class="ruby-identifier">referents</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">canonical_expression</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-typename" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">typename</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="typename-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 320</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">typename</span>
  <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">typename</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">typesym</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-typenum" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">typenum</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="typenum-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 324</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">typenum</span>
  <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">typenum</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">typesym</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-typesym" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">typesym</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="typesym-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 316</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">typesym</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">type</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/Referent/</span>, <span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">to_sym</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-update_attributes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_attributes</span><span
            class="method-args">(*params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="update_attributes-source">
            <pre><span class="ruby-comment"># File app/models/referent.rb, line 371</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_attributes</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">actuals</span> = <span class="ruby-identifier">params</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-comment"># If the parent id is changing, we need to make sure the tree stays sound</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">actuals</span>[<span class="ruby-value">:parent_id</span>]
    <span class="ruby-comment"># We&#39;re specifying a new parent:</span>
    <span class="ruby-comment">#   -- If mode is &quot;over&quot;, the parent_id gives our new parent</span>
    <span class="ruby-comment">#   -- If mode is &quot;before&quot; or &quot;after&quot;, we attach to that node&#39;s parent</span>
    <span class="ruby-identifier">parent</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">actuals</span>[<span class="ruby-value">:parent_id</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">parent</span> = <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">parent</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">actuals</span>[<span class="ruby-value">:mode</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;over&#39;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent_id</span> <span class="ruby-comment"># Avoiding redundant move</span>
        <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">add_child</span> <span class="ruby-keyword">self</span>
        <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">save</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># No parent: this node will become a root</span>
      <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent_id</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent_id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-comment"># Not already a root node...</span>
        <span class="ruby-comment"># ...make it one</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">params</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">delete</span> <span class="ruby-value">:parent_id</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">params</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">delete</span> <span class="ruby-value">:mode</span>
  <span class="ruby-comment"># Run the regular updater if there are any parameters left</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

