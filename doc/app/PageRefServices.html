<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class PageRefServices - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Object.html">Object</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-assert">::assert</a>
    
    <li ><a href="#method-c-join_urls">::join_urls</a>
    
    <li ><a href="#method-c-kind_selections">::kind_selections</a>
    
    <li ><a href="#method-c-kind_to_name">::kind_to_name</a>
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-c-selectable_kinds">::selectable_kinds</a>
    
    <li ><a href="#method-i-absorb">#absorb</a>
    
    <li ><a href="#method-i-adopt">#adopt</a>
    
    <li ><a href="#method-i-editable_entity">#editable_entity</a>
    
    <li ><a href="#method-i-ensure_status">#ensure_status</a>
    
    <li ><a href="#method-i-try_substitute">#try_substitute</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-PageRefServices">
  <h1 id="class-PageRefServices" class="class">
    class PageRefServices
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-page_ref" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">page_ref</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-assert" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">assert</span><span
            class="method-args">(kind, url)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Ensure the existence of a <a
href="PageRefServices.html#attribute-i-page_ref">#page_ref</a> of a
particular kind with the given url</p>
          
          

          
          <div class="method-source-code" id="assert-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 29</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">assert</span> <span class="ruby-identifier">kind</span>, <span class="ruby-identifier">url</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">pr</span> = <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">url</span>)
    <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">kind</span> = <span class="ruby-identifier">kind</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">persisted?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">valid?</span>
  <span class="ruby-identifier">pr</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-join_urls" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">join_urls</span><span
            class="method-args">(what)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert any relative paths in <a href="PageRef.html">PageRef</a> urls by
resort to aliases</p>
          
          

          
          <div class="method-source-code" id="join_urls-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 121</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">join_urls</span> <span class="ruby-identifier">what</span>
  (<span class="ruby-identifier">what</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;PageRef&#39;</span>).<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">domain</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">report</span> = <span class="ruby-node">&quot;Joining URLS for #{pr.class} ##{pr.id} &#39;#{pr.url}&#39;&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">url</span>.<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">uri</span> = (<span class="ruby-constant">URI</span>(<span class="ruby-identifier">pr</span>.<span class="ruby-identifier">url</span>) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>)
      <span class="ruby-comment"># report &lt;&lt; PageRefServices.new(pr).join_url</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">uri</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>.<span class="ruby-identifier">present?</span>)
        <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Rationalizing bad url &#39;#{pr.url}&#39; (PageRef ##{pr.id}) using &#39;#{pr.aliases.first}&#39;&quot;</span>
        <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">url</span> = <span class="ruby-identifier">safe_uri_join</span>(<span class="ruby-identifier">pr</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">uri</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">url</span>)
        <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;\n\t...to #{pr.url}&quot;</span>
        <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">bkg_land</span> <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">domain</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">domain</span> = <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>
        <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">what</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Definition&#39;</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">rfm</span> = <span class="ruby-constant">Referment</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">referee_type</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;PageRef&#39;</span>, <span class="ruby-identifier">referee_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">id</span>)
        <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;\n...Couldn&#39;t destroy b/c attached to Referment #{rfm.id}&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">destroy</span>
        <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;\n...destroyed URL for #{pr.class} ##{pr.id} &#39;#{pr.url}&#39;&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n...Couldn&#39;t destroy b/c not a Definition&quot;</span>
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-kind_selections" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">kind_selections</span><span
            class="method-args">(options={})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Provide an array of label/type pairs for selecting the type of a pageref</p>
          
          

          
          <div class="method-source-code" id="kind_selections-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 17</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">kind_selections</span> <span class="ruby-identifier">options</span>={}
  <span class="ruby-identifier">kinds</span> = <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">selectable_kinds</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>]
  <span class="ruby-identifier">except</span> = (<span class="ruby-identifier">options</span>[<span class="ruby-value">:except</span>] <span class="ruby-operator">||</span> []).<span class="ruby-identifier">map</span> <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span>
  <span class="ruby-identifier">kinds</span>.<span class="ruby-identifier">except</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">except</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">kind</span>, <span class="ruby-identifier">kind_id</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">kind</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&#39;_&#39;</span>,<span class="ruby-string">&#39; &#39;</span>).<span class="ruby-identifier">capitalize</span>, <span class="ruby-identifier">kind</span> ]}
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-kind_to_name" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">kind_to_name</span><span
            class="method-args">(kind)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Try to translate a <a href="PageRef.html">PageRef</a> kind into English</p>
          
          

          
          <div class="method-source-code" id="kind_to_name-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 24</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">kind_to_name</span> <span class="ruby-identifier">kind</span>
  <span class="ruby-identifier">kind</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Fixnum</span>) <span class="ruby-operator">?</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">kind_selections</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ts</span><span class="ruby-operator">|</span> <span class="ruby-identifier">kind</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ts</span>.<span class="ruby-identifier">last</span> }.<span class="ruby-identifier">first</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">kind</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&#39;_&#39;</span>, <span class="ruby-string">&#39; &#39;</span>).<span class="ruby-identifier">capitalize</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(page_ref)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 4</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span> <span class="ruby-identifier">page_ref</span>
  <span class="ruby-ivar">@page_ref</span> = <span class="ruby-identifier">page_ref</span>
  <span class="ruby-comment"># @current_user = current_user</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-selectable_kinds" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">selectable_kinds</span><span
            class="method-args">(include=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The <a href="PageRef.html">PageRef</a> kinds that are available for a user
to declare. normally, :link, :referrable, :offering, and :event are
excluded, but they can be forced by using them as parameters</p>
          
          

          
          <div class="method-source-code" id="selectable_kinds-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 12</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">selectable_kinds</span> <span class="ruby-identifier">include</span>=<span class="ruby-keyword">nil</span>
  <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">kinds</span>.<span class="ruby-identifier">except</span> <span class="ruby-operator">*</span>([<span class="ruby-value">:link</span>, <span class="ruby-value">:referrable</span>, <span class="ruby-value">:offering</span>, <span class="ruby-value">:event</span>] <span class="ruby-operator">-</span> (<span class="ruby-identifier">include</span> <span class="ruby-operator">||</span> []).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_a</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-absorb" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">absorb</span><span
            class="method-args">(other, force=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Eliminate redundancy in the PageRefs by folding two into one</p>
          
          

          
          <div class="method-source-code" id="absorb-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 76</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">absorb</span> <span class="ruby-identifier">other</span>, <span class="ruby-identifier">force</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">other</span>

  <span class="ruby-comment"># Take on all the recipes of the other</span>
  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">recipes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">other_recipe</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">other_recipe</span>.<span class="ruby-identifier">page_ref</span> = <span class="ruby-identifier">page_ref</span>
    <span class="ruby-identifier">other_recipe</span>.<span class="ruby-identifier">save</span>
  }

  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">sites</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">other_site</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">other_site</span>.<span class="ruby-identifier">page_ref</span> = <span class="ruby-identifier">page_ref</span>
    <span class="ruby-identifier">other_site</span>.<span class="ruby-identifier">save</span>
  }

  <span class="ruby-comment"># Absorb referments, taking care to elide redundancy</span>

  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">referent_ids</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref_id</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">referent_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ref_id</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">referent_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ref_id</span>)
  } <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:referent_ids</span>

  <span class="ruby-comment"># An important question is: which url (and associated status attributes) gets used in the product?</span>
  <span class="ruby-comment"># The default is to keep the absorber&#39;s attributes unless the other is shown to be good. The &#39;force&#39;</span>
  <span class="ruby-comment"># parameter allows this issue to be forced.</span>
  <span class="ruby-identifier">aliases</span> = (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">aliases</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">other</span>.<span class="ruby-identifier">url</span>, <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>]).<span class="ruby-identifier">uniq</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">force</span> <span class="ruby-operator">||</span> ((<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">!=</span> <span class="ruby-value">200</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">other</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">==</span> <span class="ruby-value">200</span>))
    <span class="ruby-identifier">hard_attribs</span> = <span class="ruby-identifier">other</span>.<span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">slice</span> <span class="ruby-operator">*</span><span class="ruby-node">%w{ errcode http_status error_message url }</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...taking #{hard_attribs} from other&quot;</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">assign_attributes</span> <span class="ruby-identifier">hard_attribs</span>

    <span class="ruby-comment"># Soft attributes are copied only if not already set</span>
    <span class="ruby-identifier">soft_attribs</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">mercury_attributes</span> <span class="ruby-operator">+</span> <span class="ruby-node">%w{ link_text }</span>
    <span class="ruby-identifier">soft_attribs</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">attrname</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">read_attribute</span>(<span class="ruby-identifier">attrname</span>).<span class="ruby-identifier">present?</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...absorbing #{attrname} = #{other.read_attribute(attrname)}&quot;</span>
        <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">write_attribute</span> <span class="ruby-identifier">attrname</span>, <span class="ruby-identifier">other</span>.<span class="ruby-identifier">read_attribute</span>(<span class="ruby-identifier">attrname</span>)
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span> = <span class="ruby-identifier">aliases</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>]

  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">id</span> <span class="ruby-comment"># May not have been saved</span>
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adopt" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adopt</span><span
            class="method-args">(other, force=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Use the attributes of another (presumably b/c a new, identical <a
href="PageRefServices.html#attribute-i-page_ref">#page_ref</a> is being
created)</p>
          
          

          
          <div class="method-source-code" id="adopt-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 68</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adopt</span> <span class="ruby-identifier">other</span>, <span class="ruby-identifier">force</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@page_ref</span>.<span class="ruby-identifier">bkg_land</span> <span class="ruby-comment"># Wait until the gleanings come in</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">other</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@page_ref</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-ivar">@page_ref</span>.<span class="ruby-identifier">title</span> = <span class="ruby-identifier">other</span>.<span class="ruby-identifier">title</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">force</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@page_ref</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-editable_entity" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">editable_entity</span><span
            class="method-args">(called_for=nil, params={})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Get a collectible, taggable entity for the <a
href="PageRef.html">PageRef</a>. Five possibilities: 1) If it has an
accompanying site, return the site 2) If it has an accompanying recipe,
return that 3) If its URL is the domain root (has no path), create and
return a new site 4) If its kind is :recipe, create and return a new recipe
5) Otherwise, just return the <a href="PageRef.html">PageRef</a> itself</p>
          
          

          
          <div class="method-source-code" id="editable_entity-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 43</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">editable_entity</span> <span class="ruby-identifier">called_for</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">params</span>={}
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">called_for</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Hash</span>
    <span class="ruby-identifier">called_for</span>, <span class="ruby-identifier">params</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">called_for</span>
  <span class="ruby-keyword">end</span>
  (<span class="ruby-identifier">page_ref</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">recipe?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">site?</span>) <span class="ruby-operator">||</span>
      (<span class="ruby-identifier">called_for</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">called_for</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Recipe</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">called_for</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Site</span>)) <span class="ruby-operator">||</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">sites</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">recipes</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-comment"># Special case: a request for a recipe on a domain (no path) gets diverted to create a site by default</span>
    <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">site?</span> <span class="ruby-operator">||</span> <span class="ruby-constant">URI</span>(<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>).<span class="ruby-identifier">path</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">?</span> <span class="ruby-constant">Site</span> <span class="ruby-operator">:</span> <span class="ruby-constant">Recipe</span>
    <span class="ruby-comment"># Initialize the recipe from parameters and extractions, as needed</span>
    <span class="ruby-comment"># defaults = page_ref.decorate.translate_params params[:page_ref], entity</span>
    <span class="ruby-identifier">defaults</span> = {
        <span class="ruby-string">&#39;Title&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page_ref</span>][<span class="ruby-value">:title</span>],
        <span class="ruby-string">&#39;href&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>,
        <span class="ruby-string">&#39;Image&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page_ref</span>][<span class="ruby-value">:picurl</span>]
    }
    <span class="ruby-identifier">defaults</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:extractions</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:extractions</span>]
    <span class="ruby-comment"># Produce a set of initializers for the target class</span>
    <span class="ruby-constant">CollectibleServices</span>.<span class="ruby-identifier">find_or_create</span> <span class="ruby-identifier">page_ref</span>, <span class="ruby-identifier">defaults</span>, <span class="ruby-identifier">klass</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ensure_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_status</span><span
            class="method-args">(force=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>So a <a href="PageRef.html">PageRef</a> exists; ensure that it has valid
status and http_status</p>
          
          

          
          <div class="method-source-code" id="ensure_status-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 150</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_status</span> <span class="ruby-identifier">force</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-comment"># Ensure that each PageRef has status and http_status</span>
  <span class="ruby-comment"># First, check on the url (may lack host and/or scheme due to earlier bug)</span>
  <span class="ruby-identifier">sentences</span> = []
  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">uri</span> = <span class="ruby-identifier">safe_parse</span>(<span class="ruby-identifier">sanitize_url</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>)) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span>.<span class="ruby-identifier">blank?</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span> = <span class="ruby-string">&#39;http&#39;</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span> = <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url_changed?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">extant</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">find_by_url</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">extant</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-comment"># Replacement URL is already being serviced by another PageRef</span>
    <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">extant</span>).<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">page_ref</span>
    <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;Destroyed redundant #{page_ref.class} ##{page_ref.id}&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">present?</span> <span class="ruby-comment"># We assume that Mercury has done its job</span>
    <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;Status already 200 on &#39;good&#39; PageRef##{page_ref.id} &#39;#{page_ref.url}&#39;&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">==</span> <span class="ruby-value">200</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good?</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> = <span class="ruby-value">200</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good!</span>
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Set status on PageRef##{page_ref.id} &#39;#{page_ref.url}&#39;: http_status &#39;#{page_ref.http_status}&#39;, status &#39;#{page_ref.status}&#39;, error &#39;#{page_ref.error_message}&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># Many circumstances under which we go out to check the reference, not nec. for the first time</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">!=</span> <span class="ruby-value">200</span>) <span class="ruby-operator">||</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">bad?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good?</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">force</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">bkg_launch</span> <span class="ruby-identifier">priority</span><span class="ruby-operator">:</span> <span class="ruby-value">10</span> <span class="ruby-comment"># Must be enqueued as a PageRef b/c subclasses aren&#39;t recognized by DJ</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Enqueued #{page_ref.class.to_s} ##{page_ref.id} &#39;#{page_ref.url}&#39; to get status&quot;</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">bkg_land</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;...returned&quot;</span>
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Ran #{page_ref.class.to_s} ##{page_ref.id} &#39;#{page_ref.url}&#39; err_msg #{page_ref.error_message} to get status: now #{page_ref.http_status}&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{page_ref.class.to_s} ##{page_ref.id} &#39;#{page_ref.url}&#39; is okay: status &#39;#{page_ref.status}&#39; http_status = #{page_ref.http_status}, url #{page_ref.url_changed? ? &#39;&#39; : &#39;not &#39;} changed.&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">==</span> <span class="ruby-value">666</span>) <span class="ruby-operator">&amp;&amp;</span>
      (<span class="ruby-identifier">match</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">error_message</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/tried to assert existing url &#39;(.*)&#39;$/</span>)) <span class="ruby-operator">&amp;&amp;</span>
      <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">&amp;&amp;</span>
      (<span class="ruby-identifier">extant</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">find_by_url</span> <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>]) <span class="ruby-operator">&amp;&amp;</span>
      (<span class="ruby-identifier">extant</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Found match PageRef ##{extant.id}&quot;</span>
    <span class="ruby-identifier">absorb</span> <span class="ruby-identifier">extant</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good!</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sentences</span>.<span class="ruby-identifier">join</span> <span class="ruby-string">&quot;\n\t&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-try_substitute" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">try_substitute</span><span
            class="method-args">(old_ptn, subst)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <pre class="ruby"><span class="ruby-comment"># Make sure the page_ref has a site</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_site</span>
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">site</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">find_or_create_for</span>(<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>) <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">site?</span>) <span class="ruby-comment"># class == SitePageRef)</span>
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span>
</pre>

<p># Try to make a URL good by applying a pattern (string or regexp)</p>
          
          

          
          <div class="method-source-code" id="try_substitute-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 207</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_substitute</span> <span class="ruby-identifier">old_ptn</span>, <span class="ruby-identifier">subst</span>
  ([<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">old_url</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">old_url</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">old_ptn</span>)
      <span class="ruby-identifier">new_url</span> = <span class="ruby-identifier">old_url</span>.<span class="ruby-identifier">sub</span> <span class="ruby-identifier">old_ptn</span>, <span class="ruby-identifier">subst</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Trying to substitute #{new_url} for #{old_url} on PageRef ##{page_ref.id}&quot;</span>
      <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>
      <span class="ruby-identifier">new_page_ref</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">fetch</span> <span class="ruby-identifier">new_url</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...got PageRef ##{new_page_ref.id || &#39;&lt;nil&gt;&#39;} &#39;#{new_page_ref.url}&#39; http_status #{new_page_ref.http_status}&quot;</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_page_ref</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_page_ref</span>.<span class="ruby-identifier">id</span> <span class="ruby-comment"># Existed prior =&gt;</span>
          <span class="ruby-comment"># Make the old page_ref represent the new URL</span>
          <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_page_ref</span>).<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">page_ref</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_page_ref</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">extant</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">find_by_url</span>(<span class="ruby-identifier">new_page_ref</span>.<span class="ruby-identifier">url</span>) <span class="ruby-comment"># new_page_ref.url already exists</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...returning ##{page_ref.id || &#39;&lt;nil&gt;&#39;} &#39;#{page_ref.url}&#39; http_status #{page_ref.http_status}&quot;</span>
          <span class="ruby-identifier">epr</span> = <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">extant</span>
          <span class="ruby-identifier">epr</span>.<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">page_ref</span>
          <span class="ruby-identifier">epr</span>.<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">new_page_ref</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">extant</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">absorb</span> <span class="ruby-identifier">new_page_ref</span>, <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...returning ##{page_ref.id || &#39;&lt;nil&gt;&#39;} &#39;#{page_ref.url}&#39; http_status #{page_ref.http_status}&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">page_ref</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

