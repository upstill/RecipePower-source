<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class PageRefServices - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Object.html">Object</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-assert_for_referent">::assert_for_referent</a>
    
    <li ><a href="#method-c-convert_reference">::convert_reference</a>
    
    <li ><a href="#method-c-def_reports">::def_reports</a>
    
    <li ><a href="#method-c-fix_references">::fix_references</a>
    
    <li ><a href="#method-c-functionally_equivalent">::functionally_equivalent</a>
    
    <li ><a href="#method-c-join_urls">::join_urls</a>
    
    <li ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-c-recipe_reports">::recipe_reports</a>
    
    <li ><a href="#method-c-report_urls">::report_urls</a>
    
    <li ><a href="#method-c-site_reports">::site_reports</a>
    
    <li ><a href="#method-i-absorb">#absorb</a>
    
    <li ><a href="#method-i-assert_referent">#assert_referent</a>
    
    <li ><a href="#method-i-ensure_site">#ensure_site</a>
    
    <li ><a href="#method-i-ensure_status">#ensure_status</a>
    
    <li ><a href="#method-i-join_url">#join_url</a>
    
    <li ><a href="#method-i-try_substitute">#try_substitute</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-PageRefServices">
  <h1 id="class-PageRefServices" class="class">
    class PageRefServices
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-page_ref" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">page_ref</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-assert_for_referent" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">assert_for_referent</span><span
            class="method-args">(uri, tag_or_referent, type=:Definition )</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Assert a reference to the given URL, linking back to a referent</p>
          
          

          
          <div class="method-source-code" id="assert_for_referent-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 55</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">assert_for_referent</span>(<span class="ruby-identifier">uri</span>, <span class="ruby-identifier">tag_or_referent</span>, <span class="ruby-identifier">type</span>=<span class="ruby-value">:Definition</span> )
  <span class="ruby-identifier">pr</span> = <span class="ruby-node">&quot;#{type}PageRef&quot;</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">fetch</span> <span class="ruby-identifier">uri</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pr</span>).<span class="ruby-identifier">assert_referent</span> <span class="ruby-identifier">tag_or_referent</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-identifier">pr</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-convert_reference" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_reference</span><span
            class="method-args">(reference, extant_pr=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert a reference, either creating a new <a
href="PageRef.html">PageRef</a> or merging it with another</p>
          
          

          
          <div class="method-source-code" id="convert_reference-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 78</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_reference</span> <span class="ruby-identifier">reference</span>, <span class="ruby-identifier">extant_pr</span>=<span class="ruby-keyword">nil</span>

  <span class="ruby-comment"># Is the only difference between the two URLs a trailing slash in the link?</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">functionally_equivalent</span> <span class="ruby-identifier">pr1</span>, <span class="ruby-identifier">pr2</span>
    <span class="ruby-identifier">uri1</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">pr1</span>.<span class="ruby-identifier">url</span>
    <span class="ruby-identifier">uri2</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">pr2</span>.<span class="ruby-identifier">url</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">uri1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">uri1</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">uri2</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\/$/</span>, <span class="ruby-string">&#39;&#39;</span>) <span class="ruby-operator">==</span> (<span class="ruby-identifier">uri1</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\/$/</span>, <span class="ruby-string">&#39;&#39;</span>)
    <span class="ruby-comment"># Mercury does not give the redirected URL for a &quot;temporary&quot; redirect, so we compare content</span>
    <span class="ruby-identifier">c1</span> = <span class="ruby-identifier">pr1</span>.<span class="ruby-identifier">content</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">c1</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">c1</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">pr2</span>.<span class="ruby-identifier">content</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>))
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">reference</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp">/Reference$/</span>, <span class="ruby-string">&#39;PageRef&#39;</span>).<span class="ruby-identifier">constantize</span>
  <span class="ruby-identifier">pr</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">fetch</span> <span class="ruby-identifier">reference</span>.<span class="ruby-identifier">url</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">pr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">extant_pr</span>
    <span class="ruby-keyword">when</span> <span class="ruby-keyword">nil</span> <span class="ruby-comment"># No PageRef existed prior</span>
      <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">save</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pr</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">pr</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">pr</span>
      <span class="ruby-identifier">extant_pr</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment"># There&#39;s an existing page_ref and it doesn&#39;t match the new one</span>
      <span class="ruby-comment"># if functionally_equivalent(extant_pr, pr) # If it&#39;s only a difference of the trailing slash...</span>
      <span class="ruby-comment"># ...just merge the new pr into the old</span>
      <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">extant_pr</span>).<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">pr</span>
      <span class="ruby-identifier">extant_pr</span>
    <span class="ruby-comment"># else</span>
    <span class="ruby-comment"># raise %Q{Reference #{reference.id} (#{reference.url}) fails to merge its PageRef (url=#{pr.url}) with existing PageRef #{extant_pr.id} (#{[[extant_pr.url]+extant_pr.aliases].join(&#39;, &#39;)})}</span>
    <span class="ruby-comment"># end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-def_reports" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">def_reports</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="def_reports-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 205</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">def_reports</span>
  <span class="ruby-identifier">reports</span> = []
  <span class="ruby-comment"># Every PageRef needs to have a parsable URL</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">type</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;DefinitionPageRef&#39;</span>, <span class="ruby-identifier">url</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; nil urls in DefinitionPageRefs&#39;</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">type</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;DefinitionReferent&#39;</span>).<span class="ruby-identifier">includes</span>(<span class="ruby-value">:page_ref</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">defref</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;Definition ##{defref.id} has no page_ref (ERROR)&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">defref</span>.<span class="ruby-identifier">page_ref</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>

  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DefinitionPageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">site_id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; nil sites in DefinitionPageRefs&#39;</span>
  <span class="ruby-comment"># Every PageRef should have at least tried to go out</span>
  <span class="ruby-identifier">bad_def_refs</span> = <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">bad</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;type = &#39;DefinitionPageRef&#39; and http_status != 200&quot;</span>)
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> [
      ((<span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">virgin</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">type</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;DefinitionPageRef&#39;</span>).<span class="ruby-identifier">count</span><span class="ruby-operator">+</span><span class="ruby-constant">DefinitionPageRef</span>.<span class="ruby-identifier">processing</span>.<span class="ruby-identifier">count</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; Definition Page Refs need processing&#39;</span>),
      (<span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">type</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;DefinitionPageRef&#39;</span>, <span class="ruby-identifier">http_status</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; Definition Page Refs have no HTTP status&#39;</span>),
      (<span class="ruby-identifier">bad_def_refs</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; bad definition refs: \n\t&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">bad_def_refs</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">dpr</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{dpr.url} (#{dpr.id}) http_status = &#39;#{dpr.http_status}&#39;&quot;</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n\t&quot;</span>))
  ]
  <span class="ruby-identifier">reports</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-fix_references" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">fix_references</span><span
            class="method-args">(what=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="fix_references-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 110</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_references</span> <span class="ruby-identifier">what</span>=<span class="ruby-keyword">nil</span>
  <span class="ruby-comment"># Make sure bad and good status align with existence of &#39;domain&#39; attribute</span>
  <span class="ruby-identifier">what</span> = <span class="ruby-identifier">what</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-value">:all</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">what</span>.<span class="ruby-identifier">to_sym</span>
  <span class="ruby-identifier">reports</span> = []
  <span class="ruby-comment"># Sites should be setup first so that other page_refs get them</span>
  <span class="ruby-keyword">if</span> [<span class="ruby-value">:all</span>, <span class="ruby-value">:sites</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">what</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">SiteServices</span>.<span class="ruby-identifier">convert_references</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">join_urls</span>(<span class="ruby-constant">Site</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">SitePageRef</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span> <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pr</span>).<span class="ruby-identifier">ensure_status</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> [<span class="ruby-value">:all</span>, <span class="ruby-value">:recipes</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">what</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">RecipeServices</span>.<span class="ruby-identifier">convert_references</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">join_urls</span> <span class="ruby-constant">Recipe</span>
    <span class="ruby-comment"># Finally, ensure that all RecipePageRef objects have either :good or :bad status and also valid http_status</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span> <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pr</span>).<span class="ruby-identifier">ensure_status</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>
    <span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">site_id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span> <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pr</span>).<span class="ruby-identifier">ensure_site</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> [<span class="ruby-value">:all</span>, <span class="ruby-value">:definitions</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">what</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">RefermentServices</span>.<span class="ruby-identifier">convert_references</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">join_urls</span> <span class="ruby-string">&#39;Definition&#39;</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">DefinitionPageRef</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span> <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pr</span>).<span class="ruby-identifier">ensure_status</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>
    <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">DefinitionPageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">site_id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span> <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pr</span>).<span class="ruby-identifier">ensure_site</span> }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># QA</span>
  <span class="ruby-identifier">bad_urls</span> = <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>(<span class="ruby-string">&#39;url LIKE ?&#39;</span>, <span class="ruby-string">&#39;http%&#39;</span>)
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{bad_urls.count} PageRefs with funky URLS&quot;</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">bad_urls</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">rpr</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;\t#{rpr.url} (#{rpr.class} ##{rpr.id})&quot;</span> }.<span class="ruby-identifier">sort</span>

  (<span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">recipe_reports</span>) <span class="ruby-keyword">if</span> [<span class="ruby-value">:all</span>, <span class="ruby-value">:recipes</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">what</span>
  (<span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">def_reports</span>) <span class="ruby-keyword">if</span> [<span class="ruby-value">:all</span>, <span class="ruby-value">:definitions</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">what</span>
  (<span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">site_reports</span>) <span class="ruby-keyword">if</span> [<span class="ruby-value">:all</span>, <span class="ruby-value">:sites</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">what</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-identifier">reports</span>.<span class="ruby-identifier">compact</span>
  <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-functionally_equivalent" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">functionally_equivalent</span><span
            class="method-args">(pr1, pr2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Is the only difference between the two URLs a trailing slash in the link?</p>
          
          

          
          <div class="method-source-code" id="functionally_equivalent-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 81</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">functionally_equivalent</span> <span class="ruby-identifier">pr1</span>, <span class="ruby-identifier">pr2</span>
  <span class="ruby-identifier">uri1</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">pr1</span>.<span class="ruby-identifier">url</span>
  <span class="ruby-identifier">uri2</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">pr2</span>.<span class="ruby-identifier">url</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">uri1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">uri1</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">uri2</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\/$/</span>, <span class="ruby-string">&#39;&#39;</span>) <span class="ruby-operator">==</span> (<span class="ruby-identifier">uri1</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span> <span class="ruby-regexp">/\/$/</span>, <span class="ruby-string">&#39;&#39;</span>)
  <span class="ruby-comment"># Mercury does not give the redirected URL for a &quot;temporary&quot; redirect, so we compare content</span>
  <span class="ruby-identifier">c1</span> = <span class="ruby-identifier">pr1</span>.<span class="ruby-identifier">content</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">c1</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">c1</span> <span class="ruby-operator">==</span> (<span class="ruby-identifier">pr2</span>.<span class="ruby-identifier">content</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;&#39;</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-join_urls" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">join_urls</span><span
            class="method-args">(what)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert any relative paths in <a href="PageRef.html">PageRef</a> urls by
resort to aliases</p>
          
          

          
          <div class="method-source-code" id="join_urls-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 147</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">join_urls</span> <span class="ruby-identifier">what</span>
  (<span class="ruby-identifier">what</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;PageRef&#39;</span>).<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">domain</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pr</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">report</span> = <span class="ruby-node">&quot;Joining URLS for #{pr.class} ##{pr.id} &#39;#{pr.url}&#39;&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">url</span>.<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pr</span>).<span class="ruby-identifier">join_url</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">what</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Definition&#39;</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">rfm</span> = <span class="ruby-constant">Referment</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">referee_type</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;PageRef&#39;</span>, <span class="ruby-identifier">referee_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">id</span>)
        <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;\n...Couldn&#39;t destroy b/c attached to Referment #{rfm.id}&quot;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">destroy</span>
        <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;\n...destroyed URL for #{pr.class} ##{pr.id} &#39;#{pr.url}&#39;&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n...Couldn&#39;t destroy b/c not a Definition&quot;</span>
    <span class="ruby-keyword">end</span>
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(page_ref)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 4</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span> <span class="ruby-identifier">page_ref</span>
  <span class="ruby-ivar">@page_ref</span> = <span class="ruby-identifier">page_ref</span>
  <span class="ruby-comment"># @current_user = current_user</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-recipe_reports" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">recipe_reports</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="recipe_reports-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 181</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">recipe_reports</span>
  <span class="ruby-identifier">reports</span> = []
  <span class="ruby-comment"># Every recipe needs to have a site and a url (page_ref)</span>
  <span class="ruby-comment"># reports &lt;&lt; Recipe.includes(:referent).to_a.collect { |recipe| &quot;Recipe ##{recipe.id} has no referent (ERROR)&quot; unless recipe.referent }.compact</span>

  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">url</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; nil urls in RecipePageRefs&#39;</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">site_id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; nil sites in RecipePageRefs&#39;</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Recipe</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:page_ref</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">rcp</span><span class="ruby-operator">|</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rcp</span>.<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>.<span class="ruby-identifier">blank?</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; nil URLs in recipes&quot;</span>

  <span class="ruby-identifier">bad</span> = <span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:recipes</span>).<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>(<span class="ruby-identifier">status</span><span class="ruby-operator">:</span> [<span class="ruby-value">0</span>,<span class="ruby-value">1</span>,<span class="ruby-value">2</span>], <span class="ruby-identifier">http_status</span><span class="ruby-operator">:</span> <span class="ruby-value">200</span>)
  <span class="ruby-identifier">unreachables</span> = <span class="ruby-constant">Recipe</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:page_ref</span>, <span class="ruby-value">:gleaning</span>).<span class="ruby-identifier">all</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">recipe</span><span class="ruby-operator">|</span> <span class="ruby-identifier">recipe</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">recipe</span>.<span class="ruby-identifier">reachable?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> }.<span class="ruby-identifier">compact</span>
  <span class="ruby-identifier">headless</span> = <span class="ruby-constant">Recipe</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:page_ref</span>).<span class="ruby-identifier">where</span>(<span class="ruby-identifier">page_ref_id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-comment"># Every PageRef should have at least tried to go out</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> [
      ((<span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">virgin</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:recipes</span>).<span class="ruby-identifier">count</span><span class="ruby-operator">+</span><span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">processing</span>.<span class="ruby-identifier">count</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; Recipe Page Refs need processing&#39;</span>),
      (<span class="ruby-constant">RecipePageRef</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:recipes</span>).<span class="ruby-identifier">where</span>(<span class="ruby-identifier">http_status</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; Recipe Page Refs have no HTTP status&#39;</span>),
      (<span class="ruby-identifier">bad</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; bad recipe refs\n\t&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">bad</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">rpr</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;&#39;#{rpr.url}&#39; (#{rpr.id}) (http_status = #{rpr.http_status}) used by recipe(s) #{rpr.recipe_ids} &quot;</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n\t&quot;</span>)),
      (<span class="ruby-identifier">unreachables</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; recipe(s) with unreachable URL (bad PageRef and bad gleaning)\n\t&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">unreachables</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">badrecipe</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{badrecipe.page_ref.url if badrecipe.page_ref} (#{badrecipe.id}) &quot;</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n\t&quot;</span>))
  ]
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> ([<span class="ruby-node">&quot;#{headless.count} recipes with no page ref:&quot;</span>] <span class="ruby-operator">+</span>
      <span class="ruby-identifier">headless</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">recipe</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;Recipe ##{recipe.id} &#39;#{recipe.url}&#39;&quot;</span> }).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n\t&quot;</span>)
  <span class="ruby-identifier">reports</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-report_urls" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">report_urls</span><span
            class="method-args">(type=:recipe)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Check for url collisions between pagerefs of a given type. This applies to
aliases as well as urls, i.e. any given url must map uniquely to one
pageref, whether through the url attribute or via aliases. This method
repairs the trivial case in which a pageref&#39;s url also appears in its
aliases</p>
          
          

          
          <div class="method-source-code" id="report_urls-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 335</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">report_urls</span> <span class="ruby-identifier">type</span>=<span class="ruby-value">:recipe</span>
  <span class="ruby-identifier">klass</span> = <span class="ruby-node">&quot;#{type.to_s.capitalize}PageRef&quot;</span>.<span class="ruby-identifier">constantize</span>
  <span class="ruby-identifier">map</span> = {}
  <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:id</span>, <span class="ruby-value">:url</span>, <span class="ruby-value">:aliases</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">arr</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">id</span>, <span class="ruby-identifier">url</span>, <span class="ruby-identifier">aliases</span> = <span class="ruby-operator">*</span><span class="ruby-identifier">arr</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">url</span>
      <span class="ruby-identifier">pr</span> = <span class="ruby-constant">PageRef</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)
      <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">url</span>
      <span class="ruby-identifier">pr</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
    (<span class="ruby-identifier">aliases</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">url</span>]).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">url</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">map</span>[<span class="ruby-identifier">url</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">id</span> }
  }
  <span class="ruby-identifier">map</span>.<span class="ruby-identifier">keep_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">url</span>, <span class="ruby-identifier">set</span><span class="ruby-operator">|</span> <span class="ruby-identifier">set</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-site_reports" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">site_reports</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="site_reports-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 222</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">site_reports</span>
  <span class="ruby-identifier">reports</span> = []
  <span class="ruby-comment"># Every site needs to have a name (referent) and home (page_ref)</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:referent</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">referent</span>
    <span class="ruby-node">&quot;Site ##{site.id} (&#39;#{site.home}&#39; has no referent (ERROR) #{(&#39;but title is &#39;+site.page_ref.title.to_s) if site.page_ref}&quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;\n\t...with #{site.definition_page_refs.count} DefinitionPageRef(s) and #{site.recipe_page_refs.count} RecipePageRef(s)&quot;</span>
  }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:page_ref</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;Site ##{site.id} (&#39;#{site.home}&#39; has no page_ref (ERROR)&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">site</span>.<span class="ruby-identifier">page_ref</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">sort</span>

  <span class="ruby-comment"># Every PageRef should have at least tried to go out</span>
  <span class="ruby-identifier">badrefids</span> = <span class="ruby-constant">SitePageRef</span>.<span class="ruby-identifier">bad</span>.<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>(<span class="ruby-identifier">http_status</span><span class="ruby-operator">:</span> <span class="ruby-value">200</span>).<span class="ruby-identifier">pluck</span>(<span class="ruby-value">:id</span>)
  <span class="ruby-identifier">reports</span> <span class="ruby-operator">+=</span> [
      (<span class="ruby-constant">SitePageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">url</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; nil site urls&#39;</span>),
      ((<span class="ruby-constant">SitePageRef</span>.<span class="ruby-identifier">virgin</span>.<span class="ruby-identifier">count</span><span class="ruby-operator">+</span><span class="ruby-constant">SitePageRef</span>.<span class="ruby-identifier">processing</span>.<span class="ruby-identifier">count</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; Site Page Refs need processing&#39;</span>),
      (<span class="ruby-constant">SitePageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">http_status</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>).<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; Site Page Refs have no HTTP status&#39;</span>),
      (<span class="ruby-identifier">badrefids</span>.<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; bad SitePageRefs: \n\t&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">SitePageRef</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">badrefids</span>).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">spr</span><span class="ruby-operator">|</span>
        <span class="ruby-node">&quot;#{spr.id}: &#39;#{spr.url}&#39; (for site ##{spr.site_id}) -&gt; #{spr.http_status}&quot;</span>
      }.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n\t&quot;</span>))
  ]
  <span class="ruby-identifier">reports</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-absorb" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">absorb</span><span
            class="method-args">(other, force=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Eliminate redundancy in the PageRefs by folding two into one</p>
          
          

          
          <div class="method-source-code" id="absorb-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 10</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">absorb</span> <span class="ruby-identifier">other</span>, <span class="ruby-identifier">force</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">other</span>

  <span class="ruby-comment"># Take on all the recipes of the other</span>
  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">recipes</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">other_recipe</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">other_recipe</span>.<span class="ruby-identifier">page_ref</span> = <span class="ruby-identifier">page_ref</span>
    <span class="ruby-identifier">other_recipe</span>.<span class="ruby-identifier">save</span>
  } <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:recipes</span>

  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">sites</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">other_site</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">other_site</span>.<span class="ruby-identifier">page_ref</span> = <span class="ruby-identifier">page_ref</span>
    <span class="ruby-identifier">other_site</span>.<span class="ruby-identifier">save</span>
  } <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:sites</span>

  <span class="ruby-comment"># Absorb referments, taking care to elide redundancy</span>

  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">referent_ids</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ref_id</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">referent_ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ref_id</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">referent_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ref_id</span>)
  } <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:referent_ids</span>

  <span class="ruby-comment"># An important question is: which url (and associated status attributes) gets used in the product?</span>
  <span class="ruby-comment"># The default is to keep the absorber&#39;s attributes unless the other is shown to be good. The &#39;force&#39;</span>
  <span class="ruby-comment"># parameter allows this issue to be forced.</span>
  <span class="ruby-identifier">aliases</span> = (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">aliases</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">other</span>.<span class="ruby-identifier">url</span>, <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>]).<span class="ruby-identifier">uniq</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">force</span> <span class="ruby-operator">||</span> ((<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">!=</span> <span class="ruby-value">200</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">other</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">==</span> <span class="ruby-value">200</span>))
    <span class="ruby-identifier">hard_attribs</span> = <span class="ruby-identifier">other</span>.<span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">slice</span> <span class="ruby-operator">*</span><span class="ruby-node">%w{ errcode http_status error_message url }</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...taking #{hard_attribs} from other&quot;</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">assign_attributes</span> <span class="ruby-identifier">hard_attribs</span>

    <span class="ruby-comment"># Soft attributes are copied only if not already set</span>
    <span class="ruby-identifier">soft_attribs</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">mercury_attributes</span> <span class="ruby-operator">+</span> <span class="ruby-node">%w{ link_text }</span>
    <span class="ruby-identifier">soft_attribs</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">attrname</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">read_attribute</span>(<span class="ruby-identifier">attrname</span>).<span class="ruby-identifier">present?</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...absorbing #{attrname} = #{other.read_attribute(attrname)}&quot;</span>
        <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">write_attribute</span> <span class="ruby-identifier">attrname</span>, <span class="ruby-identifier">other</span>.<span class="ruby-identifier">read_attribute</span>(<span class="ruby-identifier">attrname</span>)
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span> = <span class="ruby-identifier">aliases</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>]

  <span class="ruby-identifier">other</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">other</span>.<span class="ruby-identifier">id</span> <span class="ruby-comment"># May not have been saved</span>
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-assert_referent" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">assert_referent</span><span
            class="method-args">(tag_or_referent)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Associate this <a
href="PageRefServices.html#attribute-i-page_ref">#page_ref</a> with the
given referent. NB: had better be a ReferrableReferent or subclass thereof</p>
          
          

          
          <div class="method-source-code" id="assert_referent-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 63</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">assert_referent</span> <span class="ruby-identifier">tag_or_referent</span>
  <span class="ruby-identifier">rft</span> =
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">tag_or_referent</span>
        <span class="ruby-keyword">when</span> <span class="ruby-constant">Tag</span>
          <span class="ruby-constant">Referent</span>.<span class="ruby-identifier">express</span> <span class="ruby-identifier">tag_or_referent</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">tag_or_referent</span>
      <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">rft</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">referent_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rft</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">referents</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rft</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ensure_site" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_site</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Make sure the <a
href="PageRefServices.html#attribute-i-page_ref">#page_ref</a> has a site</p>
          
          

          
          <div class="method-source-code" id="ensure_site-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 295</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_site</span>
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">site</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Site</span>.<span class="ruby-identifier">find_or_create_for</span>(<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>) <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">SitePageRef</span>)
  <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ensure_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_status</span><span
            class="method-args">(force=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>So a <a href="PageRef.html">PageRef</a> exists; ensure that it has valid
status and http_status</p>
          
          

          
          <div class="method-source-code" id="ensure_status-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 246</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_status</span> <span class="ruby-identifier">force</span>=<span class="ruby-keyword">false</span>
  <span class="ruby-comment"># Ensure that each PageRef has status and http_status</span>
  <span class="ruby-comment"># First, check on the url (may lack host and/or scheme due to earlier bug)</span>
  <span class="ruby-identifier">sentences</span> = []
  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">uri</span> = <span class="ruby-identifier">safe_parse</span>(<span class="ruby-identifier">sanitize_url</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>)) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span>.<span class="ruby-identifier">blank?</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span> = <span class="ruby-string">&#39;http&#39;</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span> = <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">present?</span>
      <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url_changed?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">extant</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">find_by_url</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">extant</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-comment"># Replacement URL is already being serviced by another PageRef</span>
    <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">extant</span>).<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">page_ref</span>
    <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;Destroyed redundant #{page_ref.class} ##{page_ref.id}&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">present?</span> <span class="ruby-comment"># We assume that Mercury has done its job</span>
    <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;Status already 200 on &#39;good&#39; PageRef##{page_ref.id} &#39;#{page_ref.url}&#39;&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">==</span> <span class="ruby-value">200</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good?</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> = <span class="ruby-value">200</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good!</span>
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Set status on PageRef##{page_ref.id} &#39;#{page_ref.url}&#39;: http_status &#39;#{page_ref.http_status}&#39;, status &#39;#{page_ref.status}&#39;, error &#39;#{page_ref.error_message}&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># Many circumstances under which we go out to check the reference, not nec. for the first time</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">!=</span> <span class="ruby-value">200</span>) <span class="ruby-operator">||</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">bad?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good?</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">force</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">becomes</span>(<span class="ruby-constant">PageRef</span>).<span class="ruby-identifier">bkg_enqueue</span> <span class="ruby-identifier">priority</span><span class="ruby-operator">:</span> <span class="ruby-value">10</span> <span class="ruby-comment"># Must be enqueued as a PageRef b/c subclasses aren&#39;t recognized by DJ</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Enqueued #{page_ref.class.to_s} ##{page_ref.id} &#39;#{page_ref.url}&#39; to get status&quot;</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">bkg_asynch</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;...returned&quot;</span>
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Ran #{page_ref.class.to_s} ##{page_ref.id} &#39;#{page_ref.url}&#39; err_msg #{page_ref.error_message} to get status: now #{page_ref.http_status}&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{page_ref.class.to_s} ##{page_ref.id} &#39;#{page_ref.url}&#39; is okay: status &#39;#{page_ref.status}&#39; http_status = #{page_ref.http_status}, url #{page_ref.url_changed? ? &#39;&#39; : &#39;not &#39;} changed.&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">http_status</span> <span class="ruby-operator">==</span> <span class="ruby-value">666</span>) <span class="ruby-operator">&amp;&amp;</span>
      (<span class="ruby-identifier">match</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">error_message</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/tried to assert existing url &#39;(.*)&#39;$/</span>)) <span class="ruby-operator">&amp;&amp;</span>
      <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">&amp;&amp;</span>
      (<span class="ruby-identifier">extant</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">find_by_url</span> <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>]) <span class="ruby-operator">&amp;&amp;</span>
      (<span class="ruby-identifier">extant</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-identifier">sentences</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Found match PageRef ##{extant.id}&quot;</span>
    <span class="ruby-identifier">absorb</span> <span class="ruby-identifier">extant</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">good!</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sentences</span>.<span class="ruby-identifier">join</span> <span class="ruby-string">&quot;\n\t&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-join_url" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">join_url</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="join_url-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 165</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">join_url</span>
  <span class="ruby-identifier">uri</span> = (<span class="ruby-constant">URI</span>(<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>) <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">report</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">uri</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">scheme</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>.<span class="ruby-identifier">present?</span>)
    <span class="ruby-identifier">report</span> = <span class="ruby-node">&quot;Rationalizing bad url &#39;#{page_ref.url}&#39; (PageRef ##{page_ref.id}) using &#39;#{page_ref.aliases.first}&#39;&quot;</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span>.<span class="ruby-identifier">shift</span>, <span class="ruby-identifier">uri</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>)
    <span class="ruby-identifier">report</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;\n\t...to #{page_ref.url}&quot;</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">bkg_go</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">domain</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">domain</span> = <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>
    <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-identifier">report</span> = <span class="ruby-string">&#39;&#39;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">report</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-try_substitute" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">try_substitute</span><span
            class="method-args">(old_ptn, subst)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Try to make a URL good by applying a pattern (string or regexp)</p>
          
          

          
          <div class="method-source-code" id="try_substitute-source">
            <pre><span class="ruby-comment"># File app/services/page_ref_services.rb, line 301</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_substitute</span> <span class="ruby-identifier">old_ptn</span>, <span class="ruby-identifier">subst</span>
  ([<span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">url</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">aliases</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">old_url</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">old_url</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">old_ptn</span>)
      <span class="ruby-identifier">new_url</span> = <span class="ruby-identifier">old_url</span>.<span class="ruby-identifier">sub</span> <span class="ruby-identifier">old_ptn</span>, <span class="ruby-identifier">subst</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Trying to substitute #{new_url} for #{old_url} on PageRef ##{page_ref.id}&quot;</span>
      <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">page_ref</span>.<span class="ruby-identifier">class</span>
      <span class="ruby-identifier">new_page_ref</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">fetch</span> <span class="ruby-identifier">new_url</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...got PageRef ##{new_page_ref.id || &#39;&lt;nil&gt;&#39;} &#39;#{new_page_ref.url}&#39; http_status #{new_page_ref.http_status}&quot;</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_page_ref</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_page_ref</span>.<span class="ruby-identifier">id</span> <span class="ruby-comment"># Existed prior =&gt;</span>
          <span class="ruby-comment"># Make the old page_ref represent the new URL</span>
          <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_page_ref</span>).<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">page_ref</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_page_ref</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">extant</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">find_by_url</span>(<span class="ruby-identifier">new_page_ref</span>.<span class="ruby-identifier">url</span>) <span class="ruby-comment"># new_page_ref.url already exists</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...returning ##{page_ref.id || &#39;&lt;nil&gt;&#39;} &#39;#{page_ref.url}&#39; http_status #{page_ref.http_status}&quot;</span>
          <span class="ruby-identifier">epr</span> = <span class="ruby-constant">PageRefServices</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">extant</span>
          <span class="ruby-identifier">epr</span>.<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">page_ref</span>
          <span class="ruby-identifier">epr</span>.<span class="ruby-identifier">absorb</span> <span class="ruby-identifier">new_page_ref</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">extant</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">absorb</span> <span class="ruby-identifier">new_page_ref</span>, <span class="ruby-keyword">true</span>
          <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;...returning ##{page_ref.id || &#39;&lt;nil&gt;&#39;} &#39;#{page_ref.url}&#39; http_status #{page_ref.http_status}&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">page_ref</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

