<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->
  <%= favicon_link_tag %>
  <%= stylesheet_link_tag "application", :media => "all" %>
  <% if Rails.env.development? && true %>
      <%= javascript_include_tag "jquery-1.7.1" %>
  <% else %>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <% end %>
  <%= javascript_include_tag "application" %>
  <% logger.debug "CSRF tag: #{form_authenticity_token}" %>
  <%= csrf_meta_tag %>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%= yield(:head) %>
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-30180298-1']);
      _gaq.push(['_trackPageview']);

      (function () {
          var ga = document.createElement('script');
          ga.type = 'text/javascript';
          ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
      $(function () {
          $('.directUpload').find("input:file").each(function (i, elem) {
              var fileInput = $(elem);
              console.log(fileInput);
          });
      });
      $(function () {
          $('.directUpload').find("input:file").each(function (i, elem) {
              var fileInput = $(elem);
              var form = $(fileInput.parents('form:first'));
              var submitButton = form.find('input[type="submit"]');
              var progressBar = $("<div class='bar'></div>");
              var barContainer = $("<div class='progress'></div>").append(progressBar);
              fileInput.after(barContainer);
              fileInput.fileupload({
                  fileInput: fileInput,
                  url: '<%= @s3_direct_post.url %>',
                  type: 'POST',
                  autoUpload: true,
                  formData: <%= @s3_direct_post.fields.to_json.html_safe %>,
                  paramName: 'file', // S3 does not like nested name fields i.e. name="user[avatar_url]"
                  dataType: 'XML',  // S3 returns XML if success_action_status is set to 201
                  replaceFileInput: false,
                  progressall: function (e, data) {
                      var progress = parseInt(data.loaded / data.total * 100, 10);
                      progressBar.css('width', progress + '%')
                  },
                  start: function (e) {
                      submitButton.prop('disabled', true);

                      progressBar.
                              css('background', 'green').
                              css('display', 'block').
                              css('width', '0%').
                              text("Loading...");
                  },
                  done: function (e, data) {
                      submitButton.prop('disabled', false);
                      progressBar.text("Uploading done");

                      // extract key and generate URL from response
                      var key = $(data.jqXHR.responseXML).find("Key").text();
                      var url = '//<%= @s3_direct_post.url.host %>/' + key;

                      // create hidden field
                      var input = $("<input />", {type: 'hidden', name: fileInput.attr('name'), value: url})
                      form.append(input);
                  },
                  fail: function (e, data) {
                      submitButton.prop('disabled', false);

                      progressBar.
                              css("background", "red").
                              text("Failed");
                  }
              });
          });
      });
  </script>
</head>
<body>
<%= render 'layouts/navbar' %>
<%= render "layouts/container" %>
<% if current_user %>
    <%= template_element "tag-collectible", "tag_modal" %>
<% else %>
    <%= render partial: "registrations/new_modal" %>
<% end %>
<div id='popup_notification' class='hide alert-notice'>
  <button class="close" data-dismiss="alert">&#215;</button>
  <span>Msg Goes Here</span>
</div>
<%= feedback_tab :position => 'left' %>
<%# If there are any dialogs waiting, either in the session or the parameters %>
<%= trigger_pending_modal %>
</body>
</html>
