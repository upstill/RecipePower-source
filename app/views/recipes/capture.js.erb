/* This file is invoked by the RecipePower bookmarklet. It injects an iframe 
   onto the page, with content generated by recipePower, managing the data and functions
   at this level via the following namespace. This includes a message-passing scheme so that
	 at various points (e.g., to resize, or to close) the iframe will
   send a message back up here via a message-passing scheme from ba-postmessage. */

// Create the namespace and define our functions in it.
window.recipePower_namespace = window.recipePower_namespace || {
	
	imgs: document.getElementsByTagName('img'),
	imghandlers: [],
	iframe: undefined, // Will store the associated iframe DOM element
	
	/* Called when the X to cancel the dialog is clicked */
	retire_iframe: function () {
		if(this.iframe) {
			this.iframe.style.display = 'none';
			this.iframe.parentNode.removeChild(this.iframe);		
		}
		// Sadly obsolete: unwrapWithoutCloning();
		var script = document.getElementById("recipePower-injector");
		if(script) script.parentNode.removeChild(script);
		
		// Remove mouse-hover highlighting and click handler for images
		for(var i=0; i<this.imgs.length; i++) {
			var img = this.imgs[i];
			var parent = img.parentNode;
			var theLink = null;
			if (parent.nodeName.match(/^A$/))
				theLink = parent;
			if (img.removeEventListener) {
				img.removeEventListener('mouseover', this.mouseon, false);
				img.removeEventListener('mouseout', this.mouseoff, false);
				img.removeEventListener('click', this.imgclick, false);
				if(theLink)
					theLink.removeEventListener('click', this.aclick, false);
			} else if (img.detachEvent) {
				img.detachEvent('onmouseover', this.mouseon );
				img.detachEvent('onmouseout', this.mouseoff );
				img.detachEvent('onclick', this.imgclick );
				if(theLink)
					theLink.detachEvent('onclick', this.aclick );
			} else {
				img.onmouseover = this.imghandlers[i].mouseon;
				img.onmouseout = this.imghandlers[i].mouseoff;
				img.onclick = this.imghandlers[i].imgclick;
				if(theLink)
					theLink.onclick = this.imghandlers[i].aclick
			}	
		}
		delete this.mouseon;
		delete this.mouseoff;
		delete this.imgclick;
		delete this.aclick;
		
		// Finally, remove all trace that we were ever here.
		window.recipePower_namespace = undefined;
	},
	
	redirect_from_iframe: function (params) {
		var url = params.url[0];
		window.location = url;
	},

	execute_resize: function (dims) {
		var width = dims.width[0];
		var height = dims.height[0];

		/* Set the top margin of the encapsulation to clear the iframe
		var capsule = document.getElementById("RecipePowerInjectedEncapsulation");
		var mgn = height+"px 0px 0px 0px";
		capsule.style.margin=mgn;
		*/
		var ifr = document.getElementById("recipePower-iframe");
		ifr.style.width = width.toString() + "px";
		ifr.style.height = height.toString() + "px";
		ifr.style.top = "0";
		ifr.style.left = ((window.outerWidth-width)/2).toString() + "px";
		ifr.style.display = 'block';
	}, 
	
	redirect_to: function (msg) {
		var url = msg.url[0];
		var link = document.getElementById('recipePower-golink');
		link.href = url;
		link.click(); // Click, and VOILA! We're off to RecipePower!
	},
	
	ifrOnload: function () {
    
		// First, dispose of the placeholder and spinner images, if any
		var img = document.getElementById("recipePower-placeholder");
		var spinner = document.getElementById("recipePower-spinner");
		var ifr = this;
		if(img) {
			ifr.style.left = img.style.left;
			img.style.display = "none";
			img.parentNode.removeChild(img);			
		}
		if(spinner) {
			spinner.style.display = "none";
			spinner.parentNode.removeChild(spinner);
		}
		/*
		// Move the iframe onscreen
		var width = ifr.style.width.replace("px","");
		var offset = window.outerWidth-ifr.outerWidth;
		ifr.style.left = ((offset)/2).toString() + "px";
		*/
		ifr.style.top = "0px";
		
	  var ns = window.recipePower_namespace;
	/* We would love to encapsulate the window content so we can move the top out of the way
	   of the injected content, but it doesn't seem to work, at least on htmldog.com
		var capsule = document.getElementById("RecipePowerInjectedEncapsulation");
		if(!capsule) { 
		  capsule = wrapWithoutCloning(ifr);
		} 
		ifr.style.display = 'box';
	*/
		/* Define the style for highlighting images for picking */
		var css = 'img.recipePower-highlight { outline:#ffaa66 5px solid; }',
		    head = document.getElementsByTagName('head')[0],
		    style = document.createElement('style');

		style.type = 'text/css';
		if(style.styleSheet){
			style.styleSheet.cssText = css;
		}else{
			style.appendChild(document.createTextNode(css));
		}
		head.appendChild(style);

		// Define mouse-hover highlighting for images
		for(var i=0; i<ns.imgs.length; i++) {
			var img = ns.imgs[i];
			var parent = img.parentNode;
			var theLink = null;
			if (parent.nodeName.match(/^A$/))
				theLink = parent;
			if (img.addEventListener) {
				img.addEventListener('mouseover', ns.mouseon, false);
				img.addEventListener('mouseout', ns.mouseoff, false);
				img.addEventListener('click', ns.imgclick, false);
				if (theLink)
					theLink.addEventListener('click', ns.aclick, true);
			} else if (img.attachEvent) {
				img.attachEvent('onmouseover', ns.mouseon );
				img.attachEvent('onmouseout', ns.mouseoff );
				img.attachEvent('onclick', ns.imgclick );
				if (theLink)
					theLink.attachEvent('onclick', ns.aclick );
			} else {
				// We save the existing event handlers for restoral when closing out
				ns.imghandlers[i] = {
					mouseover: img.onmouseover,
					onmouseout: img.onmouseout,
					onclick: img.onclick
				}
				img.onmouseover = ns.mouseon;
				img.onmouseout = ns.mouseoff;
				img.onclick = ns.imgclick;
				if (theLink) {
					ns.imghandlers[i].aclick = theLink.onclick;
					theLInk.onclick = ns.aclick;
				}
			}	
		}
	},
	
	// For the benefit of mouse tracking functions below
  prev: undefined,

  mouseon: function (event) {
	  event = event || window.event;
		var ns = window.recipePower_namespace;
    if (this != ns.prev) {
			if (ns.prev) {
				ns.prev.className = ns.prev.className.replace(/\brecipePower-highlight/, '');
				ns.prev = undefined;
			}
			(ns.prev = this).className += " recipePower-highlight";
		}
	},

  mouseoff: function (event) {
	  event = event || window.event;
		this.className = this.className.replace(/\brecipePower-highlight\b/, '');
		window.recipePower_namespace.prev = undefined;
  },

  imgclick: function (event) { // Handle a click on an image by sending its url to the iframe
	  event = event || window.event;
		var ns = window.recipePower_namespace;
		var iframe = ns.iframe; // document.getElementById('recipePower-iframe')
		ns.postMessage(
			{ url: this.src,
				call: "replaceImg"
			}, "http://<%= current_domain %>", iframe.contentWindow);
		event.preventDefault();
		event.stopPropagation();
	},
	
  aclick: function (event) { // Handle a click on a link enclosing an image by sending its url to the iframe
	  event = event || window.event;
		var ns = window.recipePower_namespace;
		var iframe = ns.iframe; // document.getElementById('recipePower-iframe')
		var childImgs = this.getElementsByTagName('img')
		for(var i=0; i<childImgs.length; i++)
			ns.postMessage(
				{ url: childImgs[i].src,
					call: "replaceImg"
				}, "http://<%= current_domain %>", iframe.contentWindow);
		event.preventDefault();
		event.stopPropagation();
	},

  // Function for cracking param string
	ptq: function(q) {
		/* parse the message */
		/* semicolons are nonstandard but we accept them */
		var x = q.replace(/;/g, '&').split('&'), i, name, t;
		/* q changes from string version of query to object */
		for (q={}, i=0; i<x.length; i++) {
			t = x[i].split('=', 2);
			name = unescape(t[0]);
			if (!q[name])
				q[name] = [];
			if (t.length > 1) {
				q[name][q[name].length] = unescape(t[1]);
			} else
			/* next two lines are nonstandard */
				q[name][q[name].length] = true;
		}
		return q;
	},
	
	nlToArr: function(nl) {
		var arr = [];
		for(var i = 0; i < nl.length; i++)
			arr.push(nl[i]);
		return arr;
	},
	
	filterElementsByTag: function(candidates, tagname) {
		if(!tagname) return candidates;
		var ns = window.recipePower_namespace;
		var results = [];
		for(var i=0; i<candidates.length; i++) {
			var candidate = candidates[i];
			results = results.concat( ns.nlToArr(candidate.getElementsByTagName(tagname)) );
		}
		return results;
	},
	
	filterElementsByClassOrID: function(candidates, propname, name) {
		if(!propname) return candidates;
		var ns = window.recipePower_namespace;
		var results = [];
		for(var i=0; i<candidates.length; i++) {
			var candidate = candidates[i];
			if(propname == '.')
				results = results.concat( ns.nlToArr(candidate.getElementsByClassName(name)) );
			else if (candidate = candidate.getElementByID)
				results.push( candidate );
		}
		return results;
	},
	
	filterElementsByAttribute: function(candidates, attrname, attrval) {
		if(!attrname) return candidates;
		var results = [];
		for(var i=0; i<candidates.length; i++) {
			var candidate = candidates[i];
			var actualVal = candidate.getAttribute(attrname);
			if (actualVal && (actualVal == attrval))
				results.push( candidate );
		}
		return results;
	},
	
	getAttributeFromElements: function(elements, attrname) {
		var results = [];
		for(var i=0; i<candidates.length; i++) {
			var attrval = candidates[i].getAttribute(attrname);
			if (attrval) 
				results.push( attrval );
		}
		return results;
	},
	
	pathFilter: function(candidates, specstring) {
		var ns = window.recipePower_namespace;
		var breakdown = specstring.match(/^(\w*)((([.#])(.*))|(\[(\w*)=\'([^']*)\'\]))?/);
		var spec = { 
			tag:  breakdown[1],
			classOrIDChoice:  breakdown[4],
			classOrIDName:  breakdown[5],
			propspec:  breakdown[6],
			propname:  breakdown[7],
			propval:  breakdown[8]
		}
		candidates = ns.filterElementsByTag(candidates, spec.tag)
		candidates = ns.filterElementsByClassOrID(candidates, spec.classOrIDChoice, spec.classOrIDName)
		candidates = ns.filterElementsByAttribute(candidates, spec.propname, spec.propval)
		return candidates;
	}, 
	
	// Goes through a list of finders and extracts elements, one for each label
	applyFinders: function(finders) {
		var result = {};
		var ns = window.recipePower_namespace;
		for(var ix=0; ix<finders.length; ix++) {
			finder = finders[ix];
			if (!result[finder.label]) {
				var candidates = [window.document];
				var pathlist = finder.path.split(/\s+/);
				for(var jx=0; jx<pathlist.length; jx++) {
					candidates = ns.pathFilter(candidates, pathlist[jx]);
				}
//				if($(finder.path)[0] != candidates[0])
//					debugger;
				if (candidates.length > 0) {
					var found = null;
//					var jfound = null;
					if(finder.attribute) {
						found = candidates[0].getAttribute(finder.attribute);
//						jfound = $(finder.path).attr(finder.attribute);
					} else {
						found = candidates[0].innerHTML;
//						jfound = found;
					}
//					if(found != jfound)
//						debugger;
					result[finder.label] = found;
				} 
			}
		}
		return result;
	},
	
	encodeExtractions: function(extrs) {
		var result = "";
		for(field in extrs)
			result += "&amp;extractions["+field+"]="+encodeURIComponent(extrs[field]);
		return result;
	}
	
};

// Now create the iframe
(function() {
	// First, load the placeholder image

  var img = document.createElement("img");
  img.src = "data:image/jpeg;base64,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";
	img.style.display = 'block';
  img.style.position = 'fixed';
	img.style.top = '0';
	img.style.left = "5000px";
	img.style.zIndex = 100000002;
	img.id = "recipePower-placeholder";
	document.body.appendChild(img);
	// Move the image onscreen, centered
	img.style.left = ((window.outerWidth-800)/2).toString() + "px";

  var spinner = document.createElement("img");
  spinner.src = "data:image/gif;base64,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";
	spinner.style.display = 'block';
  spinner.style.position = 'fixed';
	spinner.style.top = '70px';
	spinner.style.left = "5000px";
	spinner.style['z-index'] = 100000003;
	spinner.id = "recipePower-spinner";
	document.body.appendChild(spinner);
	// Move the image onscreen, centered
	spinner.style.left = ((window.outerWidth-32)/2).toString() + "px";
	
	// Extract a proposed, canonical URL
	var ns = window.recipePower_namespace;
  // The extraction_js helper should declare finders for needed elements
	var callback = "<%= @url %>";
	// The finders are specifications for extracting data of different types
	var finders = JSON.parse ("<%= j SiteServices.new(@site).all_finders.to_json.html_safe %>") ;
	var extractions = ns.applyFinders(finders); // Scrape the page for definitive URL, Title and image (etc.)
	if(extractions.URI)
		extractions.URI = extractions.URI;
	extractions.href = window.location.href;
	extractions.title = extractions.title || document.title;
	callback += ns.encodeExtractions(extractions);
	
	var goer = document.createElement('a');
	goer.href = "http://<%= current_domain %>/collection"
	goer.id = 'recipePower-golink';
	goer.style.display = 'none';
	document.body.appendChild(goer);

	var ifr = document.createElement("iframe");
	// ifr.style.margin="1em";
	// Set the size of the frame to that of the placeholder image
	ifr.style.zIndex = 100000004;
	ifr.style.position = "fixed";
	ifr.style.left = "5000px"; // initially offscreen
	ifr.style.padding = "0";
	ifr.style.margin = "0";
	ifr.style.display = 'block';
	ifr.style.overflow = 'visible';
	ifr.style.border = "0px";
	ifr.id = "recipePower-iframe";
	ifr.src = callback;
	if (ifr.attachEvent){
    ifr.attachEvent("onload", window.recipePower_namespace.ifrOnload);
	} else {
    ifr.onload = window.recipePower_namespace.ifrOnload;
	}
  document.body.appendChild(ifr);
	ifr.style.display = 'block';
  window.recipePower_namespace.iframe = ifr;

})();

/* Encapsulate the body content of the page with a div wrapper.
  NB: doesn't pertain until we figure out how to do this correctly (doesn't
	work for htmldog.com) 
function wrapWithoutCloning(omitted) {
	var body = document.body;
	var wrapper = document.createElement('div'); 
	wrapper.id = "RecipePowerInjectedEncapsulation";
	// wrapper.style = body.style;
    wrapper.style.position = "absolute";
    wrapper.style.width = document.body.clientWidth; // "auto";
    wrapper.style.height = "auto";
	body.insertBefore(wrapper, body.firstChild );
	var child;
	while ((child = body.childNodes[1]) && (child != omitted)) {
		body.removeChild(child);
		wrapper.appendChild(child);
	}
	return wrapper;
}

/* Remove the previously-injected wrapper * /
function unwrapWithoutCloning() {
	var body = document.body;
	var wrapper = document.getElementById('RecipePowerInjectedEncapsulation');
	var child;
	while(child = wrapper.childNodes[0]) {
		wrapper.removeChild(child);
		body.insertBefore(child, wrapper);
	}
	body.removeChild(wrapper);
}
*/

// Define receive-message handler from ba-postmessage.js
(function($){
  // '$:nomunge'; // Used by YUI compressor.
  
  // A few vars used in non-awesome browsers.
  var interval_id,
    last_hash,
    cache_bust = 1,
    
    // A var used in awesome browsers.
    rm_callback,
    
    // A few convenient shortcuts.
    window = this,
    FALSE = !1,
    
    // Reused internal strings.
    postMessage = 'postMessage',
    addEventListener = 'addEventListener',
    
    p_receiveMessage,
    
    // I couldn't get window.postMessage to actually work in Opera 9.64!
    has_postMessage = window[postMessage] // XXX && !$.browser.opera;
  
  $.buildParam = function(parameters){
	  var qs = "";
	  for(var key in parameters) {
	    var value = parameters[key];
	    qs += encodeURIComponent(key) + "=" + encodeURIComponent(value) + "&";
	  }
	  if (qs.length > 0) {
	    qs = qs.substring(0, qs.length-1); //chop off last "&"
	  }
	  return qs;
	}
	
  $.postMessage = function( message, target_url, target ) {
    if ( !target_url ) { return; }
    
    // Serialize the message if not a string. Note that this is the only real
    // jQuery dependency for this script. If removed, this script could be
    // written as very basic JavaScript.
    message = typeof message === 'string' ? message : $.buildParam( message );
    
    // Default to parent if unspecified.
    target = target || parent;
    
    if ( has_postMessage ) {
      // The browser supports window.postMessage, so call it with a targetOrigin
      // set appropriately, based on the target_url parameter.
      target[postMessage]( message, target_url.replace( /([^:]+:\/\/[^\/]+).*/, '$1' ) );
      
    } else if ( target_url ) {
      // The browser does not support window.postMessage, so set the location
      // of the target to target_url#message. A bit ugly, but it works! A cache
      // bust parameter is added to ensure that repeat messages trigger the
      // callback.
      target.location = target_url.replace( /#.*$/, '' ) + '#' + (+new Date) + (cache_bust++) + '&' + message;
    }
  };
  
  $.receiveMessage = p_receiveMessage = function( callback, source_origin, delay ) {
    if ( has_postMessage ) {
      // Since the browser supports window.postMessage, the callback will be
      // bound to the actual event associated with window.postMessage.
      
      if ( callback ) {
        // Unbind an existing callback if it exists.
        rm_callback && p_receiveMessage();
        
        // Bind the callback. A reference to the callback is stored for ease of
        // unbinding.
        rm_callback = function(e) {
          if ( ( typeof source_origin === 'string' && e.origin !== source_origin )
             || ( (typeof source_origin === 'function') && source_origin( e.origin ) === FALSE ) ) {
            return FALSE;
          }
          callback( e );
        };
      }
      
      if ( window[addEventListener] ) {
        window[ callback ? addEventListener : 'removeEventListener' ]( 'message', rm_callback, FALSE );
      } else {
        window[ callback ? 'attachEvent' : 'detachEvent' ]( 'onmessage', rm_callback );
      }
      
    } else {
      // Since the browser sucks, a polling loop will be started, and the
      // callback will be called whenever the location.hash changes.
      
      interval_id && clearInterval( interval_id );
      interval_id = null;
      
      if ( callback ) {
        delay = typeof source_origin === 'number'
          ? source_origin
          : typeof delay === 'number'
            ? delay
            : 100;
        
        interval_id = setInterval(function(){
          var hash = document.location.hash,
            re = /^#?\d+&/;
          if ( hash !== last_hash && re.test( hash ) ) {
            last_hash = hash;
            callback({ data: hash.replace( re, '' ) });
          }
        }, delay );
      }
    }
  };

})(window.recipePower_namespace);

window.recipePower_namespace.receiveMessage( function(evt) {
	var namespace = window.recipePower_namespace;
	if(namespace) {
		// By convention, messages arrive as a query string which gets turned
		// into an object whose 'call' parameter denotes a function to call, 
		// passing in the object carrying the rest of the parameters.
		// Parse the data string as a conventional set of queryparams
		var data = namespace.ptq(evt.data);
		// Now we have a data array and a function to call
		var calls = data.call, call;
		if(calls && (call = calls[0]) && (typeof namespace[call] === 'function')) {
			namespace[call](data);
		}
	}
}, "http://<%= current_domain %>" );
